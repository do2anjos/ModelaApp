<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>Aula | Modela+</title>
    <script>
        // Inicializa√ß√£o precoce - definir tema antes do carregamento
        (function() {
            try {
                var theme = localStorage.getItem('theme') || 'system';
                if (['dark','light'].includes(theme)) {
                    document.documentElement.setAttribute('data-theme', theme);
                } else if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
                console.log('üé® Theme set early:', document.documentElement.getAttribute('data-theme'));
            } catch(e){
                console.error('‚ùå Early theme init error:', e);
            }
        })();
    </script>

    <script>
        (function() {
            try {
                var daltonism = localStorage.getItem('daltonism') || 'nenhum';
                console.log('üé® Daltonism mode:', daltonism);
                if (daltonism && daltonism !== 'nenhum') {
                    document.documentElement.setAttribute('data-daltonismo', daltonism);
                    console.log('‚úÖ Daltonism activated:', daltonism);
                } else {
                    document.documentElement.removeAttribute('data-daltonismo');
                    console.log('‚ùå Daltonism deactivated');
                }
            } catch(e){
                console.error('‚ùå Daltonism script error:', e);
            }
        })();
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/style.css">
    <style>
        /* Filtros de daltonismo aplicados imediatamente (alinhados com style.css) */
        html[data-daltonismo="protanopia"] {
            filter: contrast(1.3) saturate(0.8) brightness(1.1) sepia(0.2);
        }
        html[data-daltonismo="deuteranopia"] {
            filter: contrast(1.25) saturate(1.1) brightness(0.95) hue-rotate(-15deg);
        }
        html[data-daltonismo="tritanopia"] {
            filter: contrast(1.2) saturate(0.9) brightness(1.05) hue-rotate(30deg);
        }

        /* CORRE√á√ÉO PROFUNDA: Isola a logo dos filtros globais para prevenir invers√£o de cor */
        html[data-daltonismo] .logo img,
        .logo img,
        #main-logo,
        .lesson-header .logo img {
            filter: none !important;
            -webkit-filter: none !important; /* Compatibilidade com Safari */
            transform: none !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Prote√ß√£o absoluta contra qualquer filtro */
        .logo img::before,
        .logo img::after {
            display: none !important;
        }

        /* Manter tamanho de fonte original do t√≠tulo da aula */
        .player-header h1,
        #lesson-title-header {
            font-size: 1.5rem !important;
            margin: 0.5rem 0 0 0 !important;
            padding: 0 !important; /* Alinha com o breadcrumb */
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: var(--foreground) !important;
            line-height: 1.2 !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        /* Garantir que o container do h1 tamb√©m seja vis√≠vel */
        .player-header .header-main-content {
            display: block !important;
            width: 100% !important;
        }
    </style>
    <style>
        /* Corre√ß√£o: manter o enunciado (legend) dentro do bloco do fieldset */
        fieldset.exercise-question {
            border: 1px solid var(--border) !important;
            border-radius: var(--radius) !important;
            padding: 1.25rem !important;
            margin-bottom: 1.5rem !important;
            background: var(--card) !important;
            position: relative !important;
        }

        fieldset.exercise-question legend {
            display: block !important;
            width: 100% !important;
            max-width: 100% !important;
            font-weight: 600 !important;
            color: var(--foreground) !important;
            font-size: 1rem !important;
            line-height: 1.6 !important;
            padding: 0 0 .75rem 0 !important;
            margin: 0 0 1rem 0 !important;
            background: transparent !important;
            border-bottom: 1px solid var(--border) !important;
            text-align: justify !important;
        }

        /* Suavizar negrito do legend no dark mode */
        [data-theme="dark"] fieldset.exercise-question legend {
            font-weight: 500 !important;
        }

        fieldset.exercise-question .radio-group {
            display: flex !important;
            flex-direction: column !important;
            gap: .75rem !important;
            margin-top: .25rem !important;
        }

        /* Remover hover dos bot√µes de materiais de apoio */
        .materials-btn.button-primary {
            background-color: var(--primary) !important;
            color: var(--primary-foreground) !important;
            border-color: var(--primary) !important;
            transition: none !important;
        }
        
        .materials-btn.button-primary:hover {
            background-color: var(--primary) !important;
            color: var(--primary-foreground) !important;
            border-color: var(--primary) !important;
            opacity: 1 !important;
            transform: none !important;
        }
        
        .materials-btn.button-primary:active {
            background-color: var(--primary) !important;
            transform: scale(0.98) !important;
        }

        /* Estilos para pr√©-visualiza√ß√£o de arquivos */
        .file-preview-area {
            margin-top: 1.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--card);
            overflow: hidden;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--muted);
            border-bottom: 1px solid var(--border);
        }

        .preview-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .preview-content {
            padding: 1.5rem;
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-content img {
            max-width: 100%;
            max-height: 400px;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .preview-content iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: var(--radius);
        }

        .file-info {
            padding: 1rem 1.5rem;
            background: var(--muted);
            border-top: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .file-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .file-info-item:last-child {
            margin-bottom: 0;
        }

        .file-info-label {
            font-weight: 500;
            color: var(--muted-foreground);
        }

        .file-info-value {
            color: var(--foreground);
        }

        .file-type-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .file-upload-area {
            transition: all 0.3s ease;
        }

        .file-upload-area.dragover {
            background: var(--muted);
            border-color: var(--primary);
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .file-upload-label:hover {
            border-color: var(--primary);
            background: var(--muted);
        }

        .file-upload-label h4 {
            margin: 0;
            font-size: 1.125rem;
            color: var(--foreground);
        }

        .file-upload-label p {
            margin: 0;
            color: var(--muted-foreground);
        }

        .file-upload-label small {
            color: var(--muted-foreground);
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="lesson-body">
    <a href="#main-content" class="skip-link">Pular para o conte√∫do principal</a>

    <header class="lesson-header">
        <div class="container header-container">
            <div class="logo">
                <a href="#">
                    <img src="/images/Modela+p.png" alt="Logo da Modela+" id="main-logo">
                </a>
            </div>
            <div class="user-profile-menu">
                <button class="user-avatar-button" id="user-menu-button" aria-label="Abrir menu do usu√°rio">
                    MD
                </button>
                <div class="dropdown-menu hidden" id="user-dropdown">
                    <div class="dropdown-header">
                            <p class="user-name">Matheus dos Anjos </p>
                            <p class="user-email">mdap.lic20@uea.edu.br</p>
                        </div>
                        <ul>
                    <li><a href="/perfil.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Meu Perfil</a></li>
                    <li><a href="/configuracoes.html">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        Configura√ß√µes
                    </a></li>
                    <li><a href="/login.html">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                        Sair
                    </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <div class="lesson-page-wrapper">
        <aside class="lesson-sidebar">
            <!-- Bot√£o de toggle da sidebar -->
            <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" aria-label="Minimizar sidebar" title="Minimizar sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
            </button>
            
            <div class="sidebar-content">
                <div class="sidebar-title-wrapper">
                    <h3>T√≥picos do Curso</h3>
                    <a href="/home.html" class="sidebar-back-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m15 18-6-6 6-6"/>
                        </svg>
                        <span>Voltar</span>
                    </a>
                </div>

            <nav class="lesson-topics-nav">
                <details class="topic-accordion">
                    <summary>
    <span>Modelagem com UML</span>
    <span class="topic-progress">1/10</span>
                </summary>
                <ul class="lesson-list">
                    <li><a href="#" class="active" data-video-id="C3xYBT3o_5k"><span class="lesson-icon play"></span><span>Introdu√ß√£o √† UML - Unified Modeling Language</span><span class="lesson-duration">10:53</span></a></li>
                    <li class="lesson-locked"><a href="#" data-video-id="JQSsqMCVi1k">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>O que √© um Diagrama de Classes</span><span class="lesson-duration">10:49</span></a></li>
                    <li class="lesson-locked"><a href="#" data-video-id="IJtQWLnHvcQ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>Diagrama de Classes - Relacionamentos</span><span class="lesson-duration">17:44</span></a></li>
                    <li class="lesson-locked"><a href="#" data-video-id="ePX-S4Leq7Y">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>O que s√£o Casos de Uso</span><span class="lesson-duration">21:42</span></a></li>
                    <li class="lesson-locked"><a href="#" data-video-id="NK-BaRfFx0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>O que s√£o Diagramas de Casos de Uso</span><span class="lesson-duration">13:37</span></a></li>
                    <li class="lesson-locked"><a href="#" data-video-id="ezLX9quOVc">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>Diagrama de Casos de Uso - Exemplo B√°sico</span><span class="lesson-duration">17:26</span></a></li>
                    <li class="lesson-locked"><a href="#" data-video-id="UVkj3ed0ZuM">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>O que √© um Diagrama de Sequ√™ncia</span><span class="lesson-duration">18:56</span></a></li>
                    <li class="lesson-locked"><a href="#" data-video-id="LeV6RO-6Tn4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>Diagrama de Sequ√™ncia UML - Exemplo B√°sico</span><span class="lesson-duration">18:45</span></a></li>
                    <li class="lesson-locked"><a href="#" data-video-id="_1vHj_j3zDY">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>O que √© um Diagrama de Atividade UML - Introdu√ß√£o</span><span class="lesson-duration">13:48</span></a></li>
                    <li class="lesson-locked"><a href="#" data-video-id="N0wc9sHp5yo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>Introdu√ß√£o ao Diagrama de M√°quina de Estados UML</span><span class="lesson-duration">18:00</span></a></li>
                </ul>
                </details>

                <details class="topic-accordion locked-topic">
                <summary>
                    <span>Engenharia de Requisitos</span>
                    <span class="topic-progress">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </span>
                </summary>
                <div class="locked-content">
                    <p>Este t√≥pico ser√° desbloqueado ap√≥s a conclus√£o de "Modelagem com UML".</p>
                </div>
                </details>

                <details class="topic-accordion locked-topic">
                <summary>
                    <span>Arquitetura de Sistemas</span>
                    <span class="topic-progress">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </span>
                </summary>
                <div class="locked-content">
                    <p>Este t√≥pico ser√° desbloqueado ap√≥s a conclus√£o de "Modelagem com UML".</p>
                </div>
                </details>

                <details class="topic-accordion locked-topic">
                <summary>
                    <span>Padr√µes de Projeto</span>
                    <span class="topic-progress">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </span>
                </summary>
                <div class="locked-content">
                    <p>Este t√≥pico ser√° desbloqueado ap√≥s a conclus√£o de "Modelagem com UML".</p>
                </div>
                </details>

            </nav>
            </div> <!-- Fecha sidebar-content -->
        </aside>

        <main class="lesson-main-content" id="main-content">
            <div class="player-header">
                <div class="header-main-content">
                    <nav class="breadcrumb" aria-label="Navega√ß√£o estrutural">
                        <ol>
                            <li><a href="/home.html">In√≠cio</a></li>
                            <li><a href="/home.html">Painel</a></li>
                            <li aria-current="page">Aulas</li>
                        </ol>
                    </nav>
                    
                    <h1 id="lesson-title-header">Introdu√ß√£o √† UML - Unified Modeling Language</h1>
                </div>
                
                <div class="lesson-navigation-tabs" role="tablist" aria-label="Navega√ß√£o entre v√≠deo e exerc√≠cio">
                    <button class="tab-button active" id="video-tab" role="tab" aria-selected="true" aria-controls="video-content">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <span>V√≠deo e Conte√∫do</span>
                    </button>
                    <button class="tab-button" id="exercise-tab" role="tab" aria-selected="false" aria-controls="exercise-content" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        <span>Exerc√≠cio</span>
                        <span class="lock-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>
                    </button>
                    <button class="tab-button" id="practical-tab" role="tab" aria-selected="false" aria-controls="practical-content" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                        <span>Atividade Pr√°tica</span>
                        <span class="lock-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>
                    </button>
                </div>
                <div class="header-actions">    
                
                <div class="player-controls" role="toolbar" aria-label="Controles da aula">
                    <button class="button button-primary hidden" id="next-lesson-btn" aria-label="Ir para pr√≥xima aula" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6"></path>
                        </svg>
                        <span>Pr√≥xima Aula</span>
                        <span class="next-lesson-lock-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>
                    </button>
                </div>
                </div>
            </div>

            <div class="tab-content-wrapper">
                <!-- Painel do V√≠deo -->
                <div class="tab-content active" id="video-content" role="tabpanel" aria-labelledby="video-tab">
                    
                    <!-- Navega√ß√£o por passos -->
                    <div class="step-nav" aria-label="Navega√ß√£o entre v√≠deo e conte√∫do">
                        <button class="button step-prev" aria-label="Passo anterior" disabled>‚óÄ</button>
                        <span class="step-counter" aria-live="polite">
                            <strong class="current-step">1</strong> / <span class="total-steps">2</span>
                        </span>
                        <button class="button step-next" aria-label="Pr√≥ximo passo">‚ñ∂</button>
                    </div>

                    <div id="lesson-steps">
                        <div class="lesson-step" id="video-step">
                            <div class="video-player-wrapper">
                                <!-- O player de v√≠deo ser√° inserido aqui -->
                                <div style="padding:56.25% 0 0 0;position:relative;"><iframe src="https://player.vimeo.com/video/825944186?h=16b52755d6&amp;badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" style="position:absolute;top:0;left:0;width:100%;height:100%;" title="O que √© UML?"></iframe></div>
                            </div>
                        </div>
                        
                        <div class="lesson-step" id="reading-step" style="display: none;">
                            <section class="lesson-reading-content">
                                <h2>Conte√∫do da Aula</h2>
                                <h3 id="reading-title">Introdu√ß√£o √† UML - Unified Modeling Language</h3>
                                <div id="reading-text">
                                    <p>
                                        A Linguagem de Modelagem Unificada (UML - Unified Modeling Language) √© uma linguagem de modelagem visual de prop√≥sito geral no campo da engenharia de software, que se destina a fornecer uma maneira padr√£o de visualizar o design de um sistema.
                                    </p>
                                    <p>
                                        Criada por Grady Booch, Ivar Jacobson e James Rumbaugh (os "Tr√™s Amigos") na Rational Software durante a d√©cada de 1990, a UML foi concebida para unificar as nota√ß√µes de modelagem orientada a objetos que existiam na √©poca. A sua padroniza√ß√£o pelo Object Management Group (OMG) em 1997 consolidou-a como a linguagem de modelagem padr√£o da ind√∫stria.
                                    </p>
                                </div>
                                <div class="additional-resources">
                                    <h4>Recursos Adicionais</h4>
                                    <a href="#">Baixar material em PDF</a>
                                    <a href="#">Link para documenta√ß√£o oficial</a>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                
                <!-- Painel do Exerc√≠cio -->
                <div class="tab-content" id="exercise-content" role="tabpanel" aria-labelledby="exercise-tab">
                    <section class="lesson-exercise-content" id="exercise-section" aria-labelledby="exercise-title">
                        <h2 id="exercise-title">Exerc√≠cio</h2>
                        <p class="exercise-description">Teste seus conhecimentos sobre o conte√∫do da aula respondendo √†s quest√µes abaixo.</p>
                        
                        <div class="exercise-wrapper">
                            <div class="exercise-slide active" id="exercise-form-slide">
                                <form id="exercise-form" aria-label="Formul√°rio de exerc√≠cio">
                                    <!-- Navega√ß√£o por passos das perguntas -->
                                    <div class="step-nav" aria-label="Navega√ß√£o entre quest√µes">
                                        <button class="button step-prev" id="prev-question-form-btn" aria-label="Quest√£o anterior" disabled>‚óÄ</button>
                                        <span class="step-counter" aria-live="polite">
                                            <strong id="current-question-form">1</strong> / <span class="total-questions-form">4</span>
                                        </span>
                                        <button class="button step-next" id="next-question-form-btn" aria-label="Pr√≥xima quest√£o">‚ñ∂</button>
                                    </div>
                                    
                                    <!-- Container das quest√µes (uma por vez) -->
                                    <div class="questions-form-container">
                                        <fieldset class="exercise-question" data-question="1" style="display: block;">
                    
                                            <div class="radio-group">
                                                <legend>1. CESPE / CEBRASPE ‚Äì 2025 ‚Äì AEB ‚Äì Tecnologista J√∫nior ‚Äì Especialidade: TI<br>Acerca dos diagramas da UML, assinale a op√ß√£o correta.</legend>
                                                <label><input type="radio" name="q1" value="a" required> a) Escrever o c√≥digo-fonte final de uma aplica√ß√£o.</label>
                                                <label><input type="radio" name="q1" value="b" required> b) Fornecer uma linguagem visual padr√£o para modelar sistemas de software.</label>
                                                <label><input type="radio" name="q1" value="c" required> c) Gerenciar o cronograma e os custos de um projeto.</label>
                                                <label><input type="radio" name="q1" value="d" required> d) Testar a seguran√ßa de um banco de dados.</label>
                                            </div>
                                        </fieldset>
                                        <fieldset class="exercise-question" data-question="2" style="display: none;">
                                            <div class="radio-group">
                                                <legend>2. Quadrix ‚Äì 2023 ‚Äì COFFITO ‚Äì Analista de Tecnologia da Informa√ß√£o<br>A UML √© uma linguagem gr√°fica utilizada para modelar e visualizar sistemas de software, facilitando a comunica√ß√£o entre desenvolvedores, analistas e clientes do projeto.</legend>
                                                <label><input type="radio" name="q2" value="a" required> a) A UML serve apenas para documentar sistemas j√° implementados.</label>
                                                <label><input type="radio" name="q2" value="b" required> b) A UML √© usada exclusivamente para programa√ß√£o em linguagens orientadas a objetos.</label>
                                                <label><input type="radio" name="q2" value="c" required> c) A UML facilita a comunica√ß√£o entre desenvolvedores, analistas e clientes do projeto</label>
                                                <label><input type="radio" name="q2" value="d" required> d) A UML √© uma linguagem textual utilizada para descrever algoritmos complexos.</label>
                                            </div>
                                        </fieldset>
                                        <fieldset class="exercise-question" data-question="3" style="display: none;">
                                            <div class="radio-group">
                                                <legend>3. FGV ‚Äì 2023 ‚Äì AL-MA ‚Äì Analista de Sistemas<br>A especifica√ß√£o UML tem uma abordagem padr√£o para desenhar diagramas de classe com tr√™s itens referentes √† classe. Assinale a alternativa correta:</legend>
                                                <label><input type="radio" name="q3" value="a" required> a) Entidade, eventos e m√©todos.</label>
                                                <label><input type="radio" name="q3" value="b" required> b) Objeto, classifica√ß√£o e nome.</label>
                                                <label><input type="radio" name="q3" value="c" required> c) Atributos, m√©todos e entidade.</label>
                                                <label><input type="radio" name="q3" value="d" required> d) Nome, atributos e m√©todos.</label>
                                                <label><input type="radio" name="q3" value="e" required> e) M√©todos, objeto e eventos.</label>
                                            </div>
                                        </fieldset>
                                        <fieldset class="exercise-question" data-question="4" style="display: none;">
                                            <div class="radio-group">
                                                <legend>4. CESPE / CEBRASPE ‚Äì 2024 ‚Äì TCE-AC ‚Äì Analista de TI (Sistemas de Informa√ß√£o)<br>Em um sistema de elementos comunicantes, o diagrama de estrutura composta da UML √© uma escolha adequada para modelar a colabora√ß√£o entre entidades cooperativas na execu√ß√£o de uma fun√ß√£o espec√≠fica. Assinale a alternativa correta:</legend>
                                                <label><input type="radio" name="q4" value="a" required> a) O diagrama de estrutura composta da UML, modela a colabora√ß√£o entre partes internas de uma classe ou componente.</label>
                                                <label><input type="radio" name="q4" value="b" required> b) O diagrama de estrutura composta √© utilizado para representar o fluxo de atividades do sistema.</label>
                                                <label><input type="radio" name="q4" value="c" required> c) O diagrama de estrutura composta substitui o diagrama de classes em sistemas orientados a objetos.</label>
                                                <label><input type="radio" name="q4" value="d" required> d) O diagrama de estrutura composta serve exclusivamente para modelagem de requisitos.</label>
                                                <label><input type="radio" name="q4" value="e" required> e) O diagrama de estrutura composta √© respons√°vel pela modelagem de comportamento de atores externos</label>
                                            </div>
                                        </fieldset>
                                    </div>
                                    <div class="exercise-actions">
                                        <button type="button" id="submit-exercise" class="button button-primary">Verificar Respostas</button>
                                    </div>
                                </form>
                            </div>
                            <div class="exercise-slide" id="exercise-feedback-slide">
                                <div id="exercise-feedback" role="region" aria-live="polite" aria-label="Resultado do exerc√≠cio"></div>
                                <div class="exercise-actions">
                                    <button type="button" id="try-again-btn" class="button">Tentar Novamente</button>
                                </div>
                            </div>
                        </div>

                    </section>
                </div>

                <!-- Painel da Atividade Pr√°tica -->
                <div class="tab-content" id="practical-content" role="tabpanel" aria-labelledby="practical-tab">
                    <section class="lesson-practical-content" aria-labelledby="practical-title">
                        <h2 id="practical-title">Atividade Pr√°tica</h2>

                        <!-- Navega√ß√£o por passos -->
                        <div class="step-nav" aria-label="Navega√ß√£o por passos">
                            <button class="button step-prev" aria-label="Passo anterior" disabled>‚óÄ</button>
                            <span class="step-counter" aria-live="polite">
                                <strong>1</strong> / <span class="step-total">4</span>
                            </span>
                            <button class="button step-next" aria-label="Pr√≥ximo passo">‚ñ∂</button>
                        </div>

                        <!-- Passo 1: Modelo Orientativo -->
                        <div class="practical-step" id="practical-step-1">
                            <div class="step-header">
                                <div class="step-number">1</div>
                                <h3>Materiais de apoio</h3>
                            </div>
                            <p>Acesse os materiais de apoio para criar o seu diagrama. Voc√™ pode visualizar diretamente ou fazer download.</p>
                            
                            <!-- Grade de materiais -->
                            <div style="display: grid; gap: 1rem; margin-top: 1.5rem;">
                                
                                <!-- Card 1: Material Google Docs -->
                                <div style="border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; background: var(--card);">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #4285F4;">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg>
                                        <h4 style="margin: 0; font-size: 1rem; font-weight: 600;">Material de Apoio: Modelagem UML</h4>
                                    </div>
                                    <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--muted-foreground);">Documento com instru√ß√µes e exemplos de diagramas UML</p>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button class="button button-primary materials-btn" onclick="window.open('https://docs.google.com/document/d/1dAn3jqXbqtZUG5ESqDuLgxDuYXlvBMzfJ4j59WXUKL4/edit?tab=t.0', '_blank')" style="flex: 1; min-width: 150px;">
                                            üìÑ Visualizar Online
                                        </button>
                                    </div>
                                    <!-- Viewer inline do Google Docs (inicialmente oculto) -->
                                    <div id="docs-viewer" style="display: none; margin-top: 1rem; border-radius: var(--radius); overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <iframe src="https://docs.google.com/document/d/1dAn3jqXbqtZUG5ESqDuLgxDuYXlvBMzfJ4j59WXUKL4/preview" style="width: 100%; height: 500px; border: none;"></iframe>
                                    </div>
                                </div>
                                
                                <!-- Card 2: Livro PDF -->
                                <div style="border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; background: var(--card);">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #EA4335;">
                                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                        </svg>
                                        <h4 style="margin: 0; font-size: 1rem; font-weight: 600;">Livro: UML - Eduardo Bezerra</h4>
                                    </div>
                                    <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--muted-foreground);">Refer√™ncia completa sobre UML e modelagem de sistemas</p>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button class="button button-primary materials-btn" onclick="window.open('https://drive.google.com/file/d/1wiBHqeJHbjm8jndpn_uymGbNWHmVfdWc/view?usp=sharing', '_blank')" style="flex: 1; min-width: 150px;">
                                            üìÑ Visualizar Online
                                        </button>
                                        <a href="documents/UML_Eduardo_Bezerra.pdf" download class="button button-primary materials-btn" style="flex: 1; min-width: 150px; text-align: center; text-decoration: none;">
                                            üì• Baixar PDF
                                        </a>
                                    </div>
                                    <!-- Viewer inline do PDF (inicialmente oculto) -->
                                    <div id="pdf-viewer" style="display: none; margin-top: 1rem; border-radius: var(--radius); overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <iframe src="documents/UML_Eduardo_Bezerra.pdf" style="width: 100%; height: 600px; border: none;"></iframe>
                                    </div>
                                </div>
                                
                            </div>
                        </div>

                        <!-- Passo 2: Editor Draw.io -->
                        <div class="practical-step" id="practical-step-2">
                            <div class="step-header">
                                <div class="step-number">2</div>
                                <h3>Crie seu Diagrama</h3>
                            </div>
                            <div class="editor-help">
                                <details open>
                                    <summary>üìù Atividade Pr√°tica: Modelando um Caixa Eletr√¥nico (ATM)</summary>
                                    <div style="padding: 1rem 0;">
                                        <p style="margin-bottom: 1.5rem; font-size: 1rem; line-height: 1.6;">
                                            Vamos criar um <strong>Diagrama de Casos de Uso</strong> para um sistema super simples de Caixa Eletr√¥nico. 
                                            Voc√™ precisar√° de <strong>apenas 3 minutos</strong>!
                                        </p>

                                        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
                                            <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);">üìã Voc√™ vai precisar de:</h4>
                                            <ul style="margin: 0; padding-left: 1.5rem;">
                                                <li>3 minutos do seu tempo</li>
                                            </ul>
                                        </div>

                                        <div style="border-left: 4px solid var(--primary); padding-left: 1rem; margin-bottom: 1.5rem;">
                                            <h4 style="margin: 0 0 0.75rem 0;">üéØ Passo 1: Desenhe o Sistema</h4>
                                            <p style="margin: 0 0 0.5rem 0;">O sistema √© a "caixa" onde tudo acontece.</p>
                                            <ul style="margin: 0; padding-left: 1.5rem;">
                                                <li>Desenhe um <strong>ret√¢ngulo</strong> (uma caixa) grande no meio da sua p√°gina</li>
                                                <li>Escreva o nome do sistema no topo: <strong>"Sistema do Caixa Eletr√¥nico"</strong></li>
                                                <li style="color: var(--primary); font-weight: 500;">üí° Tudo o que estiver DENTRO desta caixa s√£o as fun√ß√µes do sistema. Tudo o que estiver FORA s√£o os usu√°rios.</li>
                                            </ul>
                                        </div>

                                        <div style="border-left: 4px solid var(--primary); padding-left: 1rem; margin-bottom: 1.5rem;">
                                            <h4 style="margin: 0 0 0.75rem 0;">üë§ Passo 2: Identifique os Atores (Quem usa?)</h4>
                                            <p style="margin: 0 0 0.5rem 0;">Atores s√£o as entidades externas que interagem com o sistema. Geralmente s√£o pessoas, mas podem ser outros sistemas.</p>
                                            <ul style="margin: 0; padding-left: 1.5rem;">
                                                <li>√Ä <strong>esquerda da caixa</strong>, desenhe um <strong>boneco-palito</strong> (stick figure)</li>
                                                <li>Escreva o nome dele abaixo: <strong>"Cliente"</strong></li>
                                            </ul>
                                        </div>

                                        <div style="border-left: 4px solid var(--primary); padding-left: 1rem; margin-bottom: 1.5rem;">
                                            <h4 style="margin: 0 0 0.75rem 0;">‚öôÔ∏è Passo 3: Identifique os Casos de Uso (O que o sistema faz?)</h4>
                                            <p style="margin: 0 0 0.5rem 0;">Casos de Uso s√£o as fun√ß√µes que o sistema oferece aos atores. Eles s√£o representados por ovais.</p>
                                            <ul style="margin: 0; padding-left: 1.5rem;">
                                                <li><strong>Dentro da caixa do sistema</strong>, desenhe <strong>tr√™s ovais</strong></li>
                                                <li>Escreva uma fun√ß√£o em cada oval:
                                                    <ul style="padding-left: 1.5rem; margin-top: 0.5rem;">
                                                        <li>"<strong>Sacar Dinheiro</strong>"</li>
                                                        <li>"<strong>Consultar Saldo</strong>"</li>
                                                        <li>"<strong>Fazer Transfer√™ncia</strong>"</li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </div>

                                        <div style="border-left: 4px solid var(--primary); padding-left: 1rem; margin-bottom: 1.5rem;">
                                            <h4 style="margin: 0 0 0.75rem 0;">üîó Passo 4: Ligue os Pontos (Quem faz o qu√™?)</h4>
                                            <p style="margin: 0 0 0.5rem 0;">Agora, simplesmente conecte os Atores aos Casos de Uso com os quais eles interagem.</p>
                                            <ul style="margin: 0; padding-left: 1.5rem;">
                                                <li>Desenhe uma <strong>linha reta</strong> do ator "Cliente" at√© o oval "<strong>Sacar Dinheiro</strong>"</li>
                                                <li>Desenhe uma <strong>linha reta</strong> do ator "Cliente" at√© o oval "<strong>Consultar Saldo</strong>"</li>
                                                <li>Desenhe uma <strong>linha reta</strong> do ator "Cliente" at√© o oval "<strong>Fazer Transfer√™ncia</strong>"</li>
                                            </ul>
                                        </div>

                                        <div style="background: hsl(142 76% 36% / 0.1); border: 1px solid hsl(142 76% 36% / 0.3); padding: 1rem; border-radius: var(--radius);">
                                            <h4 style="margin: 0 0 0.5rem 0; color: hsl(142 76% 36%);">‚úÖ Pronto! Voc√™ criou seu primeiro Diagrama de Casos de Uso!</h4>
                                            <p style="margin: 0; font-size: 0.95rem;">
                                                Agora siga para o pr√≥ximo passo onde voc√™ encontrar√° o guia r√°pido e o editor para criar a vers√£o digital do seu diagrama!
                                            </p>
                                        </div>

                                    </div>
                                </details>
                            </div>
                        </div>

                        <!-- Passo 3: Guia R√°pido do Editor -->
                        <div class="practical-step" id="practical-step-3">
                            <div class="step-header">
                                <div class="step-number">3</div>
                                <h3>üí° Guia R√°pido do Editor</h3>
                            </div>
                            <p>Aqui est√£o as principais funcionalidades e atalhos para voc√™ usar o editor de forma eficiente:</p>
                            
                            <div class="editor-guide-tabs">
                                    
                                <!-- Aba Exportar -->
                                <div class="tab-content active" id="tab-export">
                                    <h4>üì§ Exportar seu Diagrama</h4>
                                    <p style="margin-left: 0;"><strong>Passo a Passo:</strong></p>
                                    <ol style="margin-left: 1.5rem;">
                                        <li>No editor: <strong>File ‚Üí Export as ‚Üí PNG</strong></li>
                                        <li>Configure: <strong>Scale: 2x</strong> (para alta qualidade)</li>
                                        <li>Marque: <strong>Include a copy of my diagram</strong></li>
                                        <li>Clique em <strong>Export</strong></li>
                                    </ol>
                                    <p style="margin-left: 0;"><strong>Formatos Recomendados:</strong></p>
                                    <ul style="margin-left: 1.5rem;">
                                        <li><strong>PNG</strong> - Melhor para apresenta√ß√µes</li>
                                        <li><strong>SVG</strong> - Para edi√ß√£o futura</li>
                                        <li><strong>PDF</strong> - Para documentos</li>
                                    </ul>
                                </div>
                                    
                                <!-- Aba Atalhos -->
                                <div class="tab-content" id="tab-shortcuts">
                                    <h4>‚å®Ô∏è Atalhos Essenciais</h4>
                                    <p style="margin-left: 0;"><strong>Edi√ß√£o B√°sica:</strong></p>
                                    <ul style="margin-left: 1.5rem;">
                                        <li><strong>Desfazer:</strong> Ctrl + Z</li>
                                        <li><strong>Refazer:</strong> Ctrl + Y</li>
                                        <li><strong>Copiar:</strong> Ctrl + C</li>
                                        <li><strong>Colar:</strong> Ctrl + V</li>
                                        <li><strong>Duplicar:</strong> Ctrl + D</li>
                                        <li><strong>Agrupar:</strong> Ctrl + G</li>
                                        <li><strong>Desagrupar:</strong> Ctrl + Shift + G</li>
                                    </ul>
                                </div>
                                    
                                <!-- Aba Design -->
                                <div class="tab-content" id="tab-design">
                                    <h4>üé® Dicas de Design</h4>
                                    <p style="margin-left: 0;"><strong>Cores:</strong></p>
                                    <ul style="margin-left: 1.5rem;">
                                        <li>Use m√°ximo 3-4 cores principais</li>
                                        <li>Mantenha consist√™ncia visual</li>
                                        <li>Use contraste adequado</li>
                                    </ul>
                                    <p style="margin-left: 0;"><strong>Layout:</strong></p>
                                    <ul style="margin-left: 1.5rem;">
                                        <li>Alinhe elementos √† grade</li>
                                        <li>Use espa√ßamento uniforme</li>
                                        <li>Evite sobreposi√ß√µes desnecess√°rias</li>
                                    </ul>
                                </div>
                                    
                                <!-- Aba Workflow -->
                                <div class="tab-content" id="tab-workflow">
                                    <h4>üîÑ Workflow Eficiente</h4>
                                    <p style="margin-left: 0;"><strong>Dicas R√°pidas:</strong></p>
                                    <ul style="margin-left: 1.5rem;">
                                        <li>Use templates como base</li>
                                        <li>Salve frequentemente (Ctrl+S)</li>
                                        <li>Teste diferentes layouts</li>
                                        <li>Pe√ßa feedback antes de finalizar</li>
                                    </ul>
                                </div>
                                    
                                <!-- Aba Solu√ß√£o de Problemas -->
                                <div class="tab-content" id="tab-troubleshooting">
                                    <h4>üîß Solu√ß√£o de Problemas</h4>
                                    <p style="margin-left: 0;"><strong>Problemas Comuns:</strong></p>
                                    <ul style="margin-left: 1.5rem;">
                                        <li><strong>Qualidade baixa:</strong> Use Scale 2x ou 3x na exporta√ß√£o PNG</li>
                                        <li><strong>Editor lento:</strong> Feche abas desnecess√°rias</li>
                                        <li><strong>Arquivo n√£o carrega:</strong> Verifique o formato (PNG, JPG, SVG)</li>
                                    </ul>
                                </div>
                                                </div>
                                                
                            <!-- Editor UML -->
                            <div class="editor-controls">
                                <label class="select-group" for="uml-diagram-type" style="display:flex;align-items:center;gap:.5rem;">
                                    <span>Tipo:</span>
                                    <select id="uml-diagram-type" aria-label="Tipo de diagrama UML">
                                        <option value="">Selecione um tipo...</option>
                                        <option value="classes">Diagrama de Classes</option>
                                        <option value="casos-uso">Diagrama de Casos de Uso</option>
                                        <option value="sequencia">Diagrama de Sequ√™ncia</option>
                                        <option value="atividades">Diagrama de Atividades</option>
                                        <option value="estados">Diagrama de Estados</option>
                                        <option value="componentes">Diagrama de Componentes</option>
                                    </select>
                                </label>
                                <button type="button" id="test-editor-btn" class="button button-secondary" style="margin-left: 1rem;">
                                    üîÑ Testar Conex√£o
                                </button>
                                <span id="editor-status" class="status-indicator">Pronto</span>
                                                        </div>
                            <div class="uml-editor-container">
                                <iframe id="uml-editor-iframe" src="https://embed.diagrams.net/?embed=1&ui=kennedy&lang=pt-BR&noSaveBtn=1&noExitBtn=1&proto=json&libs=uml;general&grid=1&nav=1&shadow=0&splash=0" width="100%" height="600"></iframe>
                                </div>
                                
                            <div id="saved-work-preview" class="saved-work-preview hidden">
                                <h4>Seu trabalho salvo:</h4>
                                <img id="diagram-thumbnail" alt="Pr√©-visualiza√ß√£o do diagrama" />
                            </div>
                        </div>

                        <!-- Passo 4: Envio -->
                        <div class="practical-step" id="practical-step-4">
                            <div class="step-header">
                                <div class="step-number">4</div>
                                <h3>Envie seu Trabalho</h3>
                            </div>
                            <p>Envie seu diagrama para completar esta atividade.</p>

                            <!-- √Årea de upload de arquivo melhorada -->
                            <div class="file-upload-area" id="file-upload-area" style="position: relative; border: 2px dashed var(--border); border-radius: var(--radius); padding: 2rem; text-align: center; background: var(--muted); transition: all 0.3s ease; cursor: pointer;">
                                <label for="diagram-file-input" class="file-upload-label" id="file-upload-label" style="display: flex; flex-direction: column; align-items: center; gap: 1rem; cursor: pointer;">
                                    <div style="position: relative;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary);">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg>
                                        <div id="upload-progress" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
                                            <div style="width: 40px; height: 40px; border: 3px solid var(--muted); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0 0 0.5rem 0; color: var(--primary); font-size: 1.25rem;">üìÅ Selecione seu arquivo</h4>
                                        <p style="margin: 0 0 0.75rem 0; color: var(--muted-foreground);">Arraste e solte ou clique para escolher</p>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-bottom: 0.75rem;">
                                            <span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500;">PNG</span>
                                            <span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500;">JPG</span>
                                            <span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500;">SVG</span>
                                            <span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500;">PDF</span>
                                        </div>
                                        <small style="color: var(--muted-foreground);">Tamanho m√°ximo: 10MB</small>
                                    </div>
                                </label>
                                <input type="file" id="diagram-file-input" accept=".png,.jpg,.jpeg,.svg,.pdf" class="file-input" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                                <div id="file-status" class="file-status" style="margin-top: 1rem; padding: 0.75rem; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius); color: var(--muted-foreground);">Nenhum arquivo selecionado</div>
                            </div>

                            <!-- √Årea de pr√©-visualiza√ß√£o melhorada -->
                            <div id="file-preview-area" class="file-preview-area hidden" style="background: var(--muted); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin: 1.5rem 0;">
                                <div class="preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 style="margin: 0; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                                        üìÑ Pr√©-visualiza√ß√£o do arquivo
                                        <span id="file-quality-badge" style="background: hsl(142 76% 36%); color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500;">‚úì Qualidade OK</span>
                                    </h4>
                                    <button type="button" id="remove-file-btn" class="button button-ghost" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: 1px solid var(--border);">
                                        ‚úï Remover Arquivo
                                    </button>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; align-items: start;">
                                    <div id="file-preview-content" class="preview-content" style="background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                        <!-- Conte√∫do da pr√©-visualiza√ß√£o ser√° inserido aqui -->
                                    </div>
                                    
                                    <div id="file-info" class="file-info" style="background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem;">
                                        <h5 style="margin: 0 0 1rem 0; color: var(--foreground);">üìä Informa√ß√µes do Arquivo</h5>
                                        <div style="display: grid; gap: 0.75rem;">
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--muted); border-radius: 0.375rem;">
                                                <span style="font-size: 0.875rem; color: var(--muted-foreground);">Nome:</span>
                                                <span id="file-name" style="font-size: 0.875rem; font-weight: 500; word-break: break-all;">-</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--muted); border-radius: 0.375rem;">
                                                <span style="font-size: 0.875rem; color: var(--muted-foreground);">Tamanho:</span>
                                                <span id="file-size" style="font-size: 0.875rem; font-weight: 500;">-</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--muted); border-radius: 0.375rem;">
                                                <span style="font-size: 0.875rem; color: var(--muted-foreground);">Tipo:</span>
                                                <span id="file-type" style="font-size: 0.875rem; font-weight: 500;">-</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--muted); border-radius: 0.375rem;">
                                                <span style="font-size: 0.875rem; color: var(--muted-foreground);">Dimens√µes:</span>
                                                <span id="file-dimensions" style="font-size: 0.875rem; font-weight: 500;">-</span>
                                            </div>
                                        </div>
                                        
                                        <!-- An√°lise de Qualidade -->
                                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                            <h6 style="margin: 0 0 0.75rem 0; color: var(--foreground); font-size: 0.875rem;">üîç An√°lise de Qualidade</h6>
                                            <div id="quality-analysis" style="display: grid; gap: 0.5rem;">
                                                <!-- An√°lise ser√° inserida aqui dinamicamente -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bot√£o de envio melhorado -->
                            <div style="text-align: center; margin: 2rem 0;">
                                <button class="button button-success" id="submit-practical-btn" disabled style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; border-radius: var(--radius); position: relative; overflow: hidden;">
                                    <span id="submit-text">üöÄ Enviar Atividade</span>
                                    <div id="submit-progress" style="position: absolute; top: 0; left: 0; width: 0%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; display: none;"></div>
                                </button>
                                <div style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--muted-foreground);">
                                    <span id="submit-hint">Selecione um arquivo para habilitar o envio</span>
                                </div>
                            </div>

                            <!-- Feedback de sucesso melhorado -->
                            <div id="practical-feedback" class="practical-feedback hidden" style="background: linear-gradient(135deg, hsl(142 76% 36% / 0.1) 0%, hsl(142 76% 36% / 0.05) 100%); border: 1px solid hsl(142 76% 36% / 0.2); padding: 2rem; border-radius: var(--radius); text-align: center; margin: 2rem 0;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                                <h3 style="margin: 0 0 0.75rem 0; color: hsl(142 76% 36%);">Atividade Enviada com Sucesso!</h3>
                                <p style="margin: 0 0 1.5rem 0; color: var(--muted-foreground);">Parab√©ns! Seu diagrama foi enviado e est√° sendo processado.</p>
                                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                    <button class="button button-primary" onclick="location.reload()" style="padding: 0.75rem 1.5rem;">
                                        üìù Nova Atividade
                                    </button>
                                    <button class="button button-ghost" onclick="window.location.href='/aulas.html'" style="padding: 0.75rem 1.5rem;">
                                        üìö Voltar √†s Aulas
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de confirma√ß√£o de upload de arquivo -->
    <div id="file-upload-modal" class="modal-backdrop hidden" aria-hidden="true" role="dialog" aria-labelledby="file-upload-modal-title">
        <div class="modal-card" role="document">
            <h3 id="file-upload-modal-title">Arquivo carregado com sucesso</h3>
            <p>Seu arquivo foi anexado. Clique em OK para continuar.</p>
            <div class="modal-actions">
                <button class="button button-primary" id="file-upload-ok-btn" aria-label="Fechar aviso de arquivo carregado">OK</button>
            </div>
        </div>
    </div>

<!-- Scripts para gerenciar dark mode, daltonism mode e usabilidade -->
<script src="/js/auth.js"></script>
<script src="/js/dark-mode.js"></script>
<script src="/js/daltonism-mode.js"></script>
<script src="/js/usability.js"></script>
<script src="/js/lesson-nav.js"></script>
<script src="/js/exercise.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- INICIALIZA√á√ÉO DA LOGO ---
        // Aulas.html sempre usa logo branca (Modela+p.png) nativamente
        (function() {
            try {
                var logoSrc = '/images/Modela+p.png'; // Sempre branca para aulas.html
                console.log('üé® Aulas.html - Using white logo natively:', logoSrc);

                // Aplicar logo branca imediatamente
                var logos = document.querySelectorAll('img[src*="Modela"]');
                console.log('üîç Found logos:', logos.length);
                logos.forEach(function(logo, index) {
                    console.log(`üì∏ Logo ${index}:`, logo.src, '‚Üí', logoSrc);
                    console.log(`üîß Logo ${index} computed style:`, window.getComputedStyle(logo).filter);
                    // For√ßa sempre a logo branca
                    if (logo.src.includes('Modela+a.png') || logo.src.includes('Modela+p.png') || logo.src.includes('images/Modela+a.png') || logo.src.includes('images/Modela+p.png')) {
                        logo.src = logoSrc;
                    }
                });
            } catch(e){
                console.error('‚ùå Logo init error:', e);
            }
        })();

        // --- SELETORES DO DOM ---
        const lessonLinks = document.querySelectorAll('.lesson-list a');
        const videoWrapper = document.querySelector('.video-player-wrapper');
        const lessonTitleHeader = document.getElementById('lesson-title-header');
        const nextLessonBtn = document.getElementById('next-lesson-btn');
        const readingTitle = document.getElementById('reading-title');
        const readingText = document.getElementById('reading-text');
        const accordions = document.querySelectorAll('.topic-accordion');
        const exerciseSection = document.getElementById('exercise-section');
        const submitExerciseBtn = document.getElementById('submit-exercise');
        const exerciseFeedback = document.getElementById('exercise-feedback');
        const exerciseForm = document.getElementById('exercise-form');
        
        // Seletores da sidebar din√¢mica
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const lessonSidebar = document.querySelector('.lesson-sidebar');
        const lessonPageWrapper = document.querySelector('.lesson-page-wrapper');
        
        // Seletores das tabs
        const videoTab = document.getElementById('video-tab');
        const exerciseTab = document.getElementById('exercise-tab');
        const practicalTab = document.getElementById('practical-tab');
        const videoContent = document.getElementById('video-content');
        const exerciseContent = document.getElementById('exercise-content');
        const practicalContent = document.getElementById('practical-content');
        const toggleDocsViewerBtn = document.getElementById('toggle-docs-viewer');
        const togglePdfViewerBtn = document.getElementById('toggle-pdf-viewer');
        const docsViewer = document.getElementById('docs-viewer');
        const pdfViewer = document.getElementById('pdf-viewer');
        const umlEditorIframe = document.getElementById('uml-editor-iframe');
        const saveDiagramBtn = document.getElementById('save-diagram-btn');
        const savedWorkPreview = document.getElementById('saved-work-preview');
        const diagramThumbnail = document.getElementById('diagram-thumbnail');
        const submitPracticalBtn = document.getElementById('submit-practical-btn');
        const umlDiagramTypeSelect = document.getElementById('uml-diagram-type');
        const practicalFeedback = document.getElementById('practical-feedback');
        const editorStatus = document.getElementById('editor-status');
        const diagramFileInput = document.getElementById('diagram-file-input');
        const fileStatus = document.getElementById('file-status');
        const fileUploadModal = document.getElementById('file-upload-modal');
        const fileUploadOkBtn = document.getElementById('file-upload-ok-btn');
    let feedbackNextLessonBtn = document.getElementById('feedback-next-lesson-btn');

        // Navega√ß√£o entre passos da Atividade Pr√°tica
        const practicalRoot = document.querySelector('.lesson-practical-content');
        const stepElems = practicalRoot ? practicalRoot.querySelectorAll('.practical-step') : [];
        const stepPrevBtn = practicalRoot ? practicalRoot.querySelector('.step-prev') : null;
        const stepNextBtn = practicalRoot ? practicalRoot.querySelector('.step-next') : null;
        const stepCounter = practicalRoot ? practicalRoot.querySelector('.step-counter strong') : null;
        const stepTotal = practicalRoot ? practicalRoot.querySelector('.step-total') : null;

        let currentStepIndex = 0;

        function updateStepUI() {
            if (!stepElems.length) return;
            // Mostra apenas o passo atual, esconde os outros
            stepElems.forEach((el, i) => {
                el.style.display = i === currentStepIndex ? 'block' : 'none';
            });
            if (stepCounter) stepCounter.textContent = String(currentStepIndex + 1);
            if (stepPrevBtn) stepPrevBtn.disabled = currentStepIndex === 0;
            if (stepNextBtn) stepNextBtn.disabled = currentStepIndex === stepElems.length - 1;
        }

        function goToStep(index) {
            if (!stepElems.length) return;
            const i = Math.max(0, Math.min(stepElems.length - 1, index));
            currentStepIndex = i;
            // Primeiro atualiza UI para mostrar/esconder passos
            updateStepUI();
            // Depois faz scroll suave para o passo atual
            stepElems[i].scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Inicializa total e estado inicial
        if (stepTotal) stepTotal.textContent = String(stepElems.length || 0);
        updateStepUI();

        // Eventos dos bot√µes
        if (stepPrevBtn) stepPrevBtn.addEventListener('click', () => goToStep(currentStepIndex - 1));
        if (stepNextBtn) stepNextBtn.addEventListener('click', () => goToStep(currentStepIndex + 1));

        // B√¥nus: setas do teclado (‚Üê ‚Üí) navegam entre passos quando a aba pr√°tica est√° ativa
        document.addEventListener('keydown', (e) => {
            const practicalTabActive = document.getElementById('practical-content')?.classList.contains('active');
            if (!practicalTabActive) return;
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                goToStep(currentStepIndex - 1);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                goToStep(currentStepIndex + 1);
            }
        });

        // --- DADOS E ESTADO ---
        
        // Mapeamento de aulas para m√≥dulo e ID (GLOBAL)
        window.LESSON_MAPPING = {
            "Introdu√ß√£o √† UML - Unified Modeling Language": { moduleId: 1, lessonId: 1 },
            "O que √© um Diagrama de Classes": { moduleId: 1, lessonId: 2 },
            "Diagrama de Classes - Relacionamentos": { moduleId: 1, lessonId: 3 },
            "O que s√£o Casos de Uso": { moduleId: 1, lessonId: 4 },
            "O que s√£o Diagramas de Casos de Uso": { moduleId: 1, lessonId: 5 },
            "Diagrama de Casos de Uso - Exemplo B√°sico": { moduleId: 1, lessonId: 6 },
            "O que √© um Diagrama de Sequ√™ncia": { moduleId: 1, lessonId: 7 },
            "Diagrama de Sequ√™ncia UML - Exemplo B√°sico": { moduleId: 1, lessonId: 8 },
            "O que √© um Diagrama de Atividade UML - Introdu√ß√£o": { moduleId: 1, lessonId: 9 },
            "Introdu√ß√£o ao Diagrama de M√°quina de Estados UML": { moduleId: 1, lessonId: 10 }
        };
        
        const LESSON_MAPPING = window.LESSON_MAPPING; // Refer√™ncia local
        
        const lessonData = {
            "Introdu√ß√£o √† UML - Unified Modeling Language": {
                reading: "<p>A Linguagem de Modelagem Unificada (UML) √© uma linguagem padr√£o para visualizar, especificar, construir e documentar os artefatos de um sistema de software. Criada nos anos 90, unificou diversas nota√ß√µes orientadas a objetos.</p>",
                exerciseUrl: "/exercicios/uml-conceitos.html",
                correctAnswers: {
                    q1: "b",
                    q2: "c",
                    q3: "d",
                    q4: "a"
                },
                explanations: {
                    q1: {
                        correct: "Correto. A UML fornece uma linguagem visual padr√£o para modelar sistemas de software, permitindo que desenvolvedores, analistas e stakeholders visualizem, especifiquem, construam e documentem os artefatos de um sistema de forma unificada.",
                        incorrect: {
                            a: "Incorreto. A UML n√£o √© usada para escrever c√≥digo-fonte final, mas sim para modelar e visualizar sistemas antes da implementa√ß√£o. O c√≥digo √© escrito em linguagens de programa√ß√£o espec√≠ficas.",
                            b: "",
                            c: "Incorreto. A UML n√£o √© uma ferramenta de gerenciamento de projetos para cronogramas e custos. Ela √© especificamente uma linguagem de modelagem de software.",
                            d: "Incorreto. A UML n√£o √© usada para testar seguran√ßa de bancos de dados. Ela √© uma linguagem de modelagem que ajuda a visualizar e documentar sistemas de software."
                        }
                    },
                    q2: {
                        correct: "Correto. A UML √© uma linguagem gr√°fica que facilita a comunica√ß√£o entre desenvolvedores, analistas e clientes do projeto, conforme afirmado no pr√≥prio enunciado.",
                        incorrect: {
                            a: "Incorreto. A UML n√£o serve apenas para documentar sistemas j√° implementados, mas tamb√©m para projetar e visualizar sistemas antes da implementa√ß√£o.",
                            b: "Incorreto. A UML n√£o √© usada exclusivamente para linguagens orientadas a objetos, embora seja mais comum nesse contexto.",
                            c: "",
                            d: "Incorreto. A UML √© uma linguagem visual/gr√°fica, n√£o textual."
                        }
                    },
                    q3: {
                        correct: "Correto. Os tr√™s itens b√°sicos de uma classe em UML s√£o: Nome (identifica√ß√£o da classe), Atributos (caracter√≠sticas/propriedades) e M√©todos (comportamentos/opera√ß√µes).",
                        incorrect: {
                            a: "Incorreto. Entidade e eventos n√£o s√£o os tr√™s itens padr√£o de um diagrama de classes UML.",
                            b: "Incorreto. Objeto e classifica√ß√£o n√£o s√£o os tr√™s itens padr√£o de um diagrama de classes UML.",
                            c: "Incorreto. Entidade n√£o √© um dos tr√™s itens padr√£o de um diagrama de classes UML.",
                            d: "",
                            e: "Incorreto. Objeto e eventos n√£o s√£o os tr√™s itens padr√£o de um diagrama de classes UML."
                        }
                    },
                    q4: {
                        correct: "Correto. O diagrama de estrutura composta da UML 2 √© usado para modelar a colabora√ß√£o entre partes internas de uma classe ou componente, mostrando como essas partes trabalham juntas.",
                        incorrect: {
                            a: "",
                            b: "Incorreto. O diagrama de atividades √© usado para representar o fluxo de atividades, n√£o o diagrama de estrutura composta.",
                            c: "Incorreto. O diagrama de estrutura composta n√£o substitui o diagrama de classes, s√£o diagramas complementares com prop√≥sitos diferentes.",
                            d: "Incorreto. O diagrama de estrutura composta n√£o serve exclusivamente para modelagem de requisitos.",
                            e: "Incorreto. O diagrama de estrutura composta n√£o √© respons√°vel pela modelagem de comportamento de atores externos."
                        }
                    }
                }
            },
            "Relacionamentos: Associa√ß√£o e Agrega√ß√£o": {
                reading: "<p>Os relacionamentos em UML definen como as classes se conectam. Associa√ß√£o √© uma rela√ß√£o estrutural b√°sica, enquanto agrega√ß√£o √© uma forma espec√≠fica de associa√ß√£o que representa um relacionamento 'todo-parte'.</p>",
                exerciseUrl: "/exercicios/uml-relacionamentos.html",
                correctAnswers: {
                    q1: "a",
                    q2: "b",
                    q3: "c"
                },
                explanations: {
                    q1: {
                        correct: "A associa√ß√£o √© o relacionamento mais b√°sico em UML.",
                        incorrect: {
                            a: "",
                            b: "Esta n√£o √© a defini√ß√£o correta de associa√ß√£o.",
                            c: "Esta √© uma defini√ß√£o incorreta de associa√ß√£o."
                        }
                    },
                    q2: {
                        correct: "A agrega√ß√£o representa um relacionamento todo-parte.",
                        incorrect: {
                            a: "Esta √© a defini√ß√£o de associa√ß√£o, n√£o de agrega√ß√£o.",
                            b: "",
                            c: "Esta √© a defini√ß√£o de composi√ß√£o, n√£o de agrega√ß√£o."
                        }
                    },
                    q3: {
                        correct: "Na agrega√ß√£o, as partes podem existir independentemente do todo.",
                        incorrect: {
                            a: "Esta caracter√≠stica pertence √† composi√ß√£o.",
                            b: "Esta √© uma caracter√≠stica da associa√ß√£o.",
                            c: ""
                        }
                    }
                }
            },
            "Diagrama de Casos de Uso": {
                reading: "<p>O diagrama de casos de uso captura os requisitos funcionais do sistema, mostrando as intera√ß√µes entre atores externos e os casos de uso que o sistema oferece.</p>",
                exerciseUrl: "/exercicios/uml-casos-uso.html",
                correctAnswers: {
                    q1: "b",
                    q2: "a",
                    q3: "c"
                },
                explanations: {
                    q1: {
                        correct: "Os atores representam entidades externas que interagem com o sistema.",
                        incorrect: {
                            a: "Esta √© a defini√ß√£o de casos de uso, n√£o de atores.",
                            b: "",
                            c: "Esta √© a defini√ß√£o de relacionamentos, n√£o de atores."
                        }
                    },
                    q2: {
                        correct: "O relacionamento 'include' indica que um caso de uso sempre inclui o comportamento de outro.",
                        incorrect: {
                            a: "",
                            b: "Esta √© a defini√ß√£o do relacionamento 'extend'.",
                            c: "Esta √© a defini√ß√£o da generaliza√ß√£o."
                        }
                    },
                    q3: {
                        correct: "O relacionamento 'extend' indica comportamento opcional que pode ser adicionado.",
                        incorrect: {
                            a: "Esta √© a defini√ß√£o do relacionamento 'include'.",
                            b: "Esta √© a defini√ß√£o da generaliza√ß√£o.",
                            c: ""
                        }
                    }
                }
            }
        };

        // Estado do usu√°rio (ser√° resetado ao dar refresh)
        let userProgress = {};
        let currentYouTubePlayer = null;
        let videoProgressInterval = null;
        let currentLessonTitle = "";
        let currentDiagramData = { xml: null, image: null };
        // Estado de conex√£o com o editor (draw.io) - VERS√ÉO MELHORADA
        let editorReady = false;
        let editorRetries = 0;
        const maxEditorRetries = 3;
        const pendingEditorMessages = [];
        const EDITOR_BASE_URL = 'https://embed.diagrams.net/?embed=1&ui=kennedy&lang=pt-BR&noSaveBtn=1&noExitBtn=1&proto=json&libs=uml;general&grid=1&nav=1&shadow=0&splash=0';
        let editorLoadTimeout = null;

        function setEditorSrc(url) {
            if (!umlEditorIframe) return;
            
            console.log('üîÑ Recarregando editor draw.io...');
            editorReady = false;
            editorRetries = 0;
            
            // Limpa timeout anterior se existir
            if (editorLoadTimeout) {
                clearTimeout(editorLoadTimeout);
            }
            
            // Cache-buster para evitar estado antigo
            const cacheUrl = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
            umlEditorIframe.src = cacheUrl;
            
            if (editorStatus) editorStatus.textContent = 'Carregando editor...';
            
            // Timeout de seguran√ßa para recarregar se demorar muito
            editorLoadTimeout = setTimeout(() => {
                if (!editorReady && editorRetries < maxEditorRetries) {
                    console.log('‚è∞ Timeout no carregamento, tentando novamente...');
                    editorRetries++;
                    setEditorSrc(EDITOR_BASE_URL);
                }
            }, 5000);
        }

        function sendToEditor(msgObj) {
            try {
                const payload = JSON.stringify(msgObj);
                console.log('üì§ Enviando mensagem para editor:', msgObj.action || 'unknown');
                
                if (editorReady && umlEditorIframe && umlEditorIframe.contentWindow) {
                    umlEditorIframe.contentWindow.postMessage(payload, '*');
                    console.log('‚úÖ Mensagem enviada com sucesso');
                } else {
                    console.log('‚è≥ Editor n√£o pronto, enfileirando mensagem...');
                    pendingEditorMessages.push(payload);
                }
            } catch(e) {
                console.error('‚ùå Falha ao enfileirar/enviar mensagem ao editor:', e);
            }
        }

        function drainEditorQueue() {
            if (!umlEditorIframe || !umlEditorIframe.contentWindow) return;
            
            console.log(`üì¶ Processando ${pendingEditorMessages.length} mensagens enfileiradas...`);
            while (pendingEditorMessages.length) {
                const payload = pendingEditorMessages.shift();
                umlEditorIframe.contentWindow.postMessage(payload, '*');
            }
        }

        function ensureEditorReadyWithRetry() {
            return new Promise((resolve) => {
                if (editorReady) {
                    console.log('‚úÖ Editor j√° est√° pronto');
                    return resolve(true);
                }
                
                console.log('‚è≥ Aguardando editor ficar pronto...');
                
                // Timeout de seguran√ßa: se n√£o receber init em 3s, tenta recarregar
                const start = Date.now();
                const check = () => {
                    if (editorReady) {
                        console.log('‚úÖ Editor pronto ap√≥s', Date.now() - start, 'ms');
                        return resolve(true);
                    }
                    
                    if (Date.now() - start > 3000) {
                        if (editorRetries < maxEditorRetries) {
                            console.log(`üîÑ Tentativa ${editorRetries + 1}/${maxEditorRetries} - recarregando editor...`);
                            editorRetries++;
                            setEditorSrc(EDITOR_BASE_URL);
                            // aguarda novo ciclo
                            setTimeout(check, 1500);
                        } else {
                            console.error('‚ùå Falha ao carregar editor ap√≥s', maxEditorRetries, 'tentativas');
                            resolve(false);
                        }
                    } else {
                        requestAnimationFrame(check);
                    }
                };
                check();
            });
        }

        // Persist√™ncia do progresso
        async function loadProgressFromBackend() {
            try {
                const userData = localStorage.getItem('modela_user');
                if (!userData) return;
                
                const user = JSON.parse(userData);
                
                // Busca progresso de todas as aulas do m√≥dulo 1
                const response = await fetch(`/api/user/${user.id}/module/1/progress`);
                const data = await response.json();
                
                if (data.success && data.lessons) {
                    // Limpa userProgress e carrega apenas do banco
                    userProgress = {};
                    
                    data.lessons.forEach(lesson => {
                        const lessonTitle = lesson.lesson_title;
                        // CORRE√á√ÉO: Diferencia entre "desbloqueada" e "enviada"
                        // practical_completed no banco = atividade pr√°tica foi enviada
                        // Se practical_completed = true, ent√£o practicalSubmitted = true
                        userProgress[lessonTitle] = {
                            videoCompleted: !!lesson.video_completed,
                            exerciseCompleted: !!lesson.exercise_completed,
                            practicalSubmitted: !!lesson.practical_completed, // S√≥ true se foi realmente enviada
                            practicalCompleted: !!lesson.practical_completed,
                            completed: !!lesson.completed
                        };
                        
                        console.log(`üìä Progresso carregado para ${lessonTitle}:`, {
                            videoCompleted: !!lesson.video_completed,
                            exerciseCompleted: !!lesson.exercise_completed,
                            practicalSubmitted: !!lesson.practical_completed,
                            practicalCompleted: !!lesson.practical_completed,
                            completed: !!lesson.completed
                        });
                    });
                    
                    console.log('‚úÖ Progresso carregado do banco de dados:', userProgress);
                    
                    // CORRE√á√ÉO CR√çTICA: Atualiza estado visual de TODAS as aulas baseado no progresso carregado
                    updateAllLessonsVisualState();
                    
                    // ATUALIZA OS BOT√ïES AP√ìS CARREGAR O PROGRESSO
                    const activeLessonLink = document.querySelector('.lesson-list a.active');
                    if (activeLessonLink) {
                        const titleSpan = activeLessonLink.querySelector('span:not(.lesson-duration):not(.lesson-icon)');
                        const lessonTitle = titleSpan ? titleSpan.textContent.trim() : '';
                        if (lessonTitle) {
                            console.log('üîÑ Atualizando bot√µes ap√≥s carregar progresso para:', lessonTitle);
                            updateButtonStates(lessonTitle);
                            
                            // GARANTE que a aba correta esteja ativa baseada no conte√∫do atual
                            ensureCorrectTabIsActive();
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar progresso do backend:', error);
            }
        }

        // CORRE√á√ÉO CR√çTICA: Atualiza estado visual de todas as aulas baseado no progresso carregado
        function updateAllLessonsVisualState() {
            console.log('üîÑ Atualizando estado visual de todas as aulas...');
            
            lessonLinks.forEach(link => {
                const listItem = link.parentElement;
                const allSpans = link.querySelectorAll('span');
                let titleSpan = null;
                
                // Encontra o span do t√≠tulo (n√£o √© dura√ß√£o nem √≠cone)
                for (let span of allSpans) {
                    if (!span.classList.contains('lesson-duration') && !span.classList.contains('lesson-icon')) {
                        titleSpan = span;
                        break;
                    }
                }
                
                if (!titleSpan) return;
                
                const lessonTitle = titleSpan.textContent.trim();
                const progress = userProgress[lessonTitle];
                
                if (progress) {
                    console.log(`üìö Processando aula: ${lessonTitle}`, progress);
                    
                    // CORRE√á√ÉO: S√≥ desbloqueia se realmente foi marcada como conclu√≠da
                    if (progress.completed === true) {
                        listItem.classList.remove('lesson-locked');
                        listItem.classList.add('lesson-unlocked');
                        
                        // Remove √≠cone de cadeado e adiciona √≠cone de aula conclu√≠da
                        const lockIcon = listItem.querySelector('svg');
                        if (lockIcon) {
                            lockIcon.remove();
                        }
                        
                        // Adiciona √≠cone de aula conclu√≠da
                        let iconSpan = link.querySelector('.lesson-icon');
                        if (!iconSpan) {
                            iconSpan = document.createElement('span');
                            iconSpan.className = 'lesson-icon';
                            link.insertBefore(iconSpan, link.firstChild);
                        }
                        iconSpan.className = 'lesson-icon completed';
                        
                        console.log(`‚úÖ Aula desbloqueada: ${lessonTitle}`);
                    } else {
                        // Verifica se deve estar bloqueada (aula anterior n√£o conclu√≠da)
                        const currentIndex = Array.from(lessonLinks).indexOf(link);
                        if (currentIndex > 0) {
                            const previousLink = lessonLinks[currentIndex - 1];
                            const previousTitleSpan = previousLink.querySelector('span:not(.lesson-duration):not(.lesson-icon)');
                            const previousTitle = previousTitleSpan ? previousTitleSpan.textContent.trim() : '';
                            const previousProgress = userProgress[previousTitle];
                            
                            if (!previousProgress || !previousProgress.completed) {
                                listItem.classList.add('lesson-locked');
                                listItem.classList.remove('lesson-unlocked');
                                
                                // Adiciona √≠cone de cadeado se n√£o existir
                                if (!listItem.querySelector('svg')) {
                                    const lockIcon = document.createElement('svg');
                                    lockIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                                    lockIcon.setAttribute('width', '16');
                                    lockIcon.setAttribute('height', '16');
                                    lockIcon.setAttribute('viewBox', '0 0 24 24');
                                    lockIcon.setAttribute('fill', 'none');
                                    lockIcon.setAttribute('stroke', 'currentColor');
                                    lockIcon.setAttribute('stroke-width', '2');
                                    lockIcon.setAttribute('stroke-linecap', 'round');
                                    lockIcon.setAttribute('stroke-linejoin', 'round');
                                    lockIcon.innerHTML = '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>';
                                    link.insertBefore(lockIcon, link.firstChild);
                                }
                                
                                console.log(`üîí Aula bloqueada: ${lessonTitle}`);
                            }
                        }
                    }
                }
            });
            
            // Atualiza contadores de progresso
            accordions.forEach(accordion => {
                updateTopicProgress(accordion);
            });
        }

        // CORRE√á√ÉO: Move updateUserProgress para escopo global para evitar erro de refer√™ncia
        window.updateUserProgress = function(lessonTitle, updates) {
            if (!userProgress[lessonTitle]) userProgress[lessonTitle] = {};
            Object.assign(userProgress[lessonTitle], updates);
            
            // Sincroniza com o backend
            syncProgressToBackend(lessonTitle);
            
            // CORRE√á√ÉO: Verificar conclus√£o de m√≥dulo APENAS quando uma aula √© realmente conclu√≠da
            // e n√£o a cada atualiza√ß√£o de progresso
            if (updates.completed === true || updates.fullyCompleted === true) {
                const userData = localStorage.getItem('modela_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    const mapping = LESSON_MAPPING[lessonTitle];
                    if (mapping) {
                        console.log('üéØ Verificando conclus√£o de m√≥dulo ap√≥s conclus√£o de aula');
                        checkModuleCompletion(user.id, mapping.moduleId);
                    }
                }
            }
        };
        
        // Sincroniza progresso com o backend
        function syncProgressToBackend(lessonTitle) {
            try {
                const userData = localStorage.getItem('modela_user');
                if (!userData) return;
                
                const user = JSON.parse(userData);
                const progress = userProgress[lessonTitle] || {};
                const mapping = LESSON_MAPPING[lessonTitle];
                
                if (!mapping) {
                    console.warn('‚ö†Ô∏è Aula n√£o mapeada:', lessonTitle);
                    return;
                }
                
                const payload = {
                    moduleId: mapping.moduleId,
                    lessonId: mapping.lessonId,
                    lessonTitle: lessonTitle,
                    videoCompleted: progress.videoCompleted || false,
                    exerciseCompleted: progress.exerciseCompleted || false,
                    practicalCompleted: progress.practicalSubmitted || progress.practicalCompleted || false,
                    completed: progress.completed || false
                };
                
                fetch(`/api/user/${user.id}/progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(r => r.json())
                .then(data => {
                    console.log('‚úÖ Progresso sincronizado com backend:', lessonTitle, data);
                })
                .catch(err => {
                    console.error('‚ùå Erro ao sincronizar progresso:', err);
                });
            } catch (e) {
                console.error('‚ùå Erro na fun√ß√£o syncProgressToBackend:', e);
            }
        }

        // Fun√ß√£o para mostrar notifica√ß√£o de pontos
        function showPointsNotification(points) {
            const notification = document.createElement('div');
            notification.className = 'points-notification';
            notification.innerHTML = `+${points} pontos! üéâ`;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Fun√ß√£o para verificar conclus√£o de m√≥dulo e pontuar (COM VERIFICA√á√ÉO DE DUPLICA√á√ÉO)
        async function checkModuleCompletion(userId, moduleId) {
            try {
                console.log(`üîç Verificando conclus√£o do m√≥dulo ${moduleId} para usu√°rio ${userId}`);
                
                // Buscar progresso do m√≥dulo
                const response = await fetch(`/api/user/${userId}/module/${moduleId}/progress`);
                const data = await response.json();
                
                if (!data.success) {
                    console.error('Erro ao buscar progresso do m√≥dulo:', data.message);
                    return;
                }
                
                // Verificar se todas as 10 aulas foram completadas
                const allCompleted = data.lessons.every(lesson => 
                    lesson.video_completed && 
                    lesson.exercise_completed && 
                    lesson.practical_completed
                );
                
                console.log(`üìä M√≥dulo ${moduleId}: ${allCompleted ? 'COMPLETO' : 'INCOMPLETO'} (${data.lessons.length} aulas)`);
                
                if (allCompleted) {
                    // CORRE√á√ÉO: Adicionar pontos do m√≥dulo (o backend j√° verifica duplica√ß√£o)
                    const scoreResponse = await fetch(`/api/user/${userId}/score`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scoreType: 'module',
                            sourceId: moduleId.toString(),
                            points: 50
                        })
                    });
                    
                    const scoreResult = await scoreResponse.json();
                    
                    if (scoreResponse.ok) {
                        if (scoreResult.alreadyExists) {
                            console.log('‚ö†Ô∏è Pontos do m√≥dulo j√° foram adicionados anteriormente');
                        } else {
                            showPointsNotification(50);
                            console.log('‚úÖ M√≥dulo completo! +50 pontos adicionados');
                        }
                    } else {
                        console.error('‚ùå Erro ao adicionar pontos do m√≥dulo:', scoreResult);
                    }
                } else {
                    console.log('‚è≥ M√≥dulo ainda n√£o est√° completo');
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar conclus√£o do m√≥dulo:', error);
            }
        }

        // --- FUN√á√ïES ---

        // --- FUN√á√ïES DA SIDEBAR DIN√ÇMICA ---
        
        // Inicializa o estado da sidebar baseado no localStorage
        function initializeSidebarState() {
            const isMinimized = localStorage.getItem('sidebarMinimized') === 'true';
            if (isMinimized) {
                minimizeSidebar();
            }
        }
        
        // Minimiza a sidebar
        function minimizeSidebar() {
            lessonSidebar.classList.add('minimized');
            lessonPageWrapper.classList.add('sidebar-minimized');
            sidebarToggleBtn.classList.add('minimized');
            sidebarToggleBtn.setAttribute('aria-label', 'Maximizar sidebar');
            sidebarToggleBtn.setAttribute('title', 'Maximizar sidebar');
            localStorage.setItem('sidebarMinimized', 'true');
            console.log('üîΩ Sidebar minimizada');
        }
        
        // Maximiza a sidebar
        function maximizeSidebar() {
            lessonSidebar.classList.remove('minimized');
            lessonPageWrapper.classList.remove('sidebar-minimized');
            sidebarToggleBtn.classList.remove('minimized');
            sidebarToggleBtn.setAttribute('aria-label', 'Minimizar sidebar');
            sidebarToggleBtn.setAttribute('title', 'Minimizar sidebar');
            localStorage.setItem('sidebarMinimized', 'false');
            console.log('üîº Sidebar maximizada');
        }
        
        // Alterna o estado da sidebar
        function toggleSidebar() {
            if (lessonSidebar.classList.contains('minimized')) {
                maximizeSidebar();
            } else {
                minimizeSidebar();
            }
        }

        // Fun√ß√£o para rolar suavemente para um elemento com offset
        function smoothScrollToElement(element, offset = 80) {
            const elementPosition = element.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - offset;

            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }

        // Alterna entre as tabs de v√≠deo, exerc√≠cio e pr√°tica
        function switchTab(tabName) {
            if (tabName === 'video') {
                videoTab.classList.add('active');
                videoTab.setAttribute('aria-selected', 'true');
                exerciseTab.classList.remove('active');
                exerciseTab.setAttribute('aria-selected', 'false');
                if (typeof practicalTab !== 'undefined') {
                    practicalTab.classList.remove('active');
                    practicalTab.setAttribute('aria-selected', 'false');
                }
                
                videoContent.classList.add('active');
                exerciseContent.classList.remove('active');
                const practicalContent = document.getElementById('practical-content');
                if (practicalContent) practicalContent.classList.remove('active');
            } else if (tabName === 'exercise') {
                if (exerciseTab.disabled) {
                    alert('Complete o v√≠deo para acessar o exerc√≠cio.');
                    return;
                }
                
                exerciseTab.classList.add('active');
                exerciseTab.setAttribute('aria-selected', 'true');
                videoTab.classList.remove('active');
                videoTab.setAttribute('aria-selected', 'false');
                if (typeof practicalTab !== 'undefined') {
                    practicalTab.classList.remove('active');
                    practicalTab.setAttribute('aria-selected', 'false');
                }
                
                exerciseContent.classList.add('active');
                videoContent.classList.remove('active');
                const practicalContent = document.getElementById('practical-content');
                if (practicalContent) practicalContent.classList.remove('active');
                
                // Rola suavemente para o topo
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (tabName === 'practical') {
                const practicalTab = document.getElementById('practical-tab');
                if (!practicalTab || practicalTab.disabled) {
                    alert('Complete o exerc√≠cio com 100% para acessar a atividade pr√°tica.');
                    return;
                }
                const practicalContent = document.getElementById('practical-content');
                practicalTab.classList.add('active');
                practicalTab.setAttribute('aria-selected', 'true');
                videoTab.classList.remove('active');
                videoTab.setAttribute('aria-selected', 'false');
                exerciseTab.classList.remove('active');
                exerciseTab.setAttribute('aria-selected', 'false');
                if (practicalContent) practicalContent.classList.add('active');
                videoContent.classList.remove('active');
                exerciseContent.classList.remove('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Carrega o conte√∫do de uma aula espec√≠fica (COM REIN√çCIO DO CICLO)
        function loadLesson(lessonLink, isInitialLoad = false) {
            console.log('üé¨ loadLesson chamada com:', lessonLink, 'isInitialLoad:', isInitialLoad);
            
            // Obt√©m o t√≠tulo da nova aula que ser√° carregada
            const newTitleSpan = lessonLink.querySelector('span:not(.lesson-duration):not(.lesson-icon)');
            const newLessonTitle = newTitleSpan ? newTitleSpan.textContent.trim() : '';
            
            // REIN√çCIO DO CICLO: Reseta estado das abas para nova aula
            console.log('üîÑ Reiniciando ciclo para nova aula...');
            
            // CORRE√á√ÉO: N√£o limpa mais o estado do exerc√≠cio ao trocar de aula
            // O estado s√≥ deve ser limpo quando o usu√°rio clica em "Tentar Novamente"
            // Isso permite que o feedback seja preservado ao navegar entre aulas
            if (!isInitialLoad) {
                const previousLesson = window.getCurrentLessonTitle ? window.getCurrentLessonTitle() : '';
                if (previousLesson && previousLesson !== newLessonTitle) {
                    console.log('üîÑ Trocando de aula:', previousLesson, '‚Üí', newLessonTitle);
                    console.log('üìù Estado do exerc√≠cio da aula anterior ser√° MANTIDO');
                } else if (previousLesson === newLessonTitle) {
                    console.log('üîÑ Mesma aula - mantendo estado do exerc√≠cio');
                }
            } else {
                console.log('üîÑ Carga inicial - estado do exerc√≠cio ser√° restaurado');
            }

            // 1. Bloqueia todas as abas inicialmente e garante que o bot√£o "Pr√≥xima Aula" fique DISABLED
            lockExerciseTab();
            lockPracticalTab();
            try {
                // Garante que o bot√£o de pr√≥xima aula esteja travado (disabled) e oculto
                if (typeof lockNextLessonButton === 'function') lockNextLessonButton();
            } catch (e) {
                console.warn('‚ö†Ô∏è lockNextLessonButton n√£o dispon√≠vel:', e);
            }
            hideNextLessonButton();
            
            // Desativa a aula anterior
            lessonLinks.forEach(link => {
                link.classList.remove('active');
                const icon = link.querySelector('.lesson-icon');
                if (icon && icon.classList.contains('play')) {
                    icon.classList.remove('play');
                    if (!icon.classList.contains('completed')) icon.classList.add('todo');
                }
            });

            // Ativa a nova aula
            lessonLink.classList.add('active');
            
            // Encontra o √≠cone da aula (pode ser .lesson-icon ou SVG)
            let activeIcon = lessonLink.querySelector('.lesson-icon');
            if (!activeIcon) {
                // Se n√£o tem .lesson-icon, cria um
                activeIcon = document.createElement('span');
                activeIcon.className = 'lesson-icon play';
                lessonLink.insertBefore(activeIcon, lessonLink.firstChild);
            } else if (!activeIcon.classList.contains('completed')) {
                activeIcon.classList.remove('todo');
                activeIcon.classList.add('play');
            }
            
            // Carrega o v√≠deo e o texto
            const videoId = lessonLink.getAttribute('data-video-id');
            console.log('üé• Video ID:', videoId);
            
            // Corrige sele√ß√£o do t√≠tulo da aula (pega o segundo span, n√£o o √≠cone nem a dura√ß√£o)
            const allSpans = lessonLink.querySelectorAll('span');
            let titleSpan = null;
            for (let span of allSpans) {
                if (!span.classList.contains('lesson-duration') && !span.classList.contains('lesson-icon')) {
                    titleSpan = span;
                    break;
                }
            }
            currentLessonTitle = titleSpan ? titleSpan.textContent : 'Aula sem t√≠tulo';
            console.log('üìù T√≠tulo da aula:', currentLessonTitle);
            
            videoWrapper.innerHTML = `<div id="youtube-player"></div>`;
            
            lessonTitleHeader.textContent = currentLessonTitle;
            readingTitle.textContent = currentLessonTitle;
            
            // Carrega material de leitura espec√≠fico da aula
            const lessonInfo = lessonData[currentLessonTitle] || {};
            readingText.innerHTML = lessonInfo.reading || "<p>Nenhum material de leitura dispon√≠vel para esta aula.</p>";

            // Inicializa o player do YouTube
            initializeYouTubePlayer(videoId, currentLessonTitle);

            // REIN√çCIO DO CICLO: Atualiza estado dos bot√µes baseado no progresso salvo
            updateButtonStates(currentLessonTitle, activeIcon);

            // Reinicia o formul√°rio de exerc√≠cios
            resetExerciseForm();

            // FLUXO CORRETO: Reseta para a tab de v√≠deo (reinicia o ciclo)
            switchTab('video');

            // Rola para o topo da p√°gina suavemente
            setTimeout(() => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }, 300);
            
            console.log('‚úÖ Ciclo reiniciado para:', currentLessonTitle);
        }

        // Inicializa o player do YouTube com API
        function initializeYouTubePlayer(videoId, lessonTitle) {
            // Para qualquer intervalo de progresso anterior
            if (videoProgressInterval) {
                clearInterval(videoProgressInterval);
                videoProgressInterval = null;
            }

            if (window.YT && window.YT.Player) {
                createYouTubePlayer(videoId, lessonTitle);
            } else {
                // Carrega a API do YouTube se n√£o estiver carregada
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                
                window.onYouTubeIframeAPIReady = function() {
                    createYouTubePlayer(videoId, lessonTitle);
                };
            }
        }

        function createYouTubePlayer(videoId, lessonTitle) {
            if (currentYouTubePlayer) {
                currentYouTubePlayer.destroy();
            }

            currentYouTubePlayer = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'enablejsapi': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });

            function onPlayerReady(event) {
                console.log('Player pronto para:', lessonTitle);
            }

            function onPlayerStateChange(event) {
                // Inicia verifica√ß√£o de progresso quando o v√≠deo come√ßa a tocar
                if (event.data === YT.PlayerState.PLAYING) {
                    startVideoProgressCheck(lessonTitle);
                } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                    // Para a verifica√ß√£o quando pausa ou termina
                    if (videoProgressInterval) {
                        clearInterval(videoProgressInterval);
                        videoProgressInterval = null;
                    }
                    
                    // Verifica se chegou ao final quando termina
                    if (event.data === YT.PlayerState.ENDED) {
                        handleVideoCompleted(lessonTitle);
                    }
                }
            }

            function onPlayerError(event) {
                console.error('Erro no player YouTube:', event.data);
            }
        }

        // Inicia a verifica√ß√£o de progresso do v√≠deo
        function startVideoProgressCheck(lessonTitle) {
            if (videoProgressInterval) {
                clearInterval(videoProgressInterval);
            }

            videoProgressInterval = setInterval(() => {
                if (currentYouTubePlayer && currentYouTubePlayer.getCurrentTime && currentYouTubePlayer.getDuration) {
                    const currentTime = currentYouTubePlayer.getCurrentTime();
                    const duration = currentYouTubePlayer.getDuration();
                    
                    if (duration > 0) {
                        const progress = (currentTime / duration) * 100;
                        
                        // Salva progresso atual (em mem√≥ria apenas)
                        if (!userProgress[lessonTitle]) {
                            userProgress[lessonTitle] = {};
                        }
                        userProgress[lessonTitle].videoProgress = progress;
                        
                        // Mostra bot√£o de exerc√≠cio se atingiu 90% ou mais (para garantir que funciona)
                        if (progress >= 90 && !userProgress[lessonTitle].videoCompleted) {
                            handleVideoCompleted(lessonTitle);
                            clearInterval(videoProgressInterval);
                            videoProgressInterval = null;
                        }
                    }
                }
            }, 1000); // Verifica a cada 1 segundo
        }

        function handleVideoCompleted(lessonTitle) {
            console.log('‚úÖ V√≠deo completado:', lessonTitle);
            
            // Salva progresso no banco de dados
            updateUserProgress(lessonTitle, {
                videoCompleted: true,
                videoProgress: 100
            });
            
            // Atualiza estado dos bot√µes ap√≥s completar v√≠deo
            updateButtonStates(lessonTitle);
            
            // Atualiza o √≠cone da aula para mostrar que o v√≠deo foi assistido
            const activeLessonLink = document.querySelector('.lesson-list a.active');
            if (activeLessonLink) {
                const activeIcon = activeLessonLink.querySelector('.lesson-icon');
                if (activeIcon && !activeIcon.classList.contains('completed')) {
                    activeIcon.classList.remove('play');
                    activeIcon.classList.add('video-watched');
                }
            }
        }

        function unlockExerciseTab() {
            exerciseTab.disabled = false;
            const lockIndicator = exerciseTab.querySelector('.lock-indicator');
            if (lockIndicator) {
                lockIndicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle></svg>';
            }
            exerciseTab.style.opacity = '1';
            console.log('üîì Tab de exerc√≠cio desbloqueada');
        }

        function lockExerciseTab() {
            exerciseTab.disabled = true;
            const lockIndicator = exerciseTab.querySelector('.lock-indicator');
            if (lockIndicator) {
                lockIndicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
            }
            exerciseTab.style.opacity = '0.5';
        }


        // Controle da aba de Atividade Pr√°tica
        function unlockPracticalTab() {
            if (!practicalTab) {
                console.log('‚ùå practicalTab n√£o encontrado');
                return;
            }
            console.log('üîì Desbloqueando aba Atividade Pr√°tica');
            
            // Remove todas as classes de bloqueio
            practicalTab.classList.remove('disabled', 'locked');
            practicalTab.disabled = false;
            
            // Atualiza o √≠cone de cadeado para check
            const lockIndicator = practicalTab.querySelector('.lock-indicator');
            if (lockIndicator) {
                lockIndicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle></svg>';
            }
            
            // Remove qualquer estilo inline de opacidade
            practicalTab.style.opacity = '1';
            practicalTab.style.cursor = 'pointer';
            
            console.log('‚úÖ Aba Atividade Pr√°tica desbloqueada:', practicalTab.disabled);
        }

        // Exp√µe a fun√ß√£o globalmente para prevenir ReferenceError quando chamada de outras rotinas
        try {
            window.unlockPracticalTab = unlockPracticalTab;
        } catch (e) {
            console.warn('‚ö†Ô∏è N√£o foi poss√≠vel expor unlockPracticalTab no window:', e);
        }

        function lockPracticalTab() {
            if (!practicalTab) return;
            
            // Adiciona classes de bloqueio
            practicalTab.classList.add('disabled', 'locked');
            practicalTab.disabled = true;
            
            // Atualiza o √≠cone para cadeado
            const lockIndicator = practicalTab.querySelector('.lock-indicator');
            if (lockIndicator) {
                lockIndicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
            }
            
            // Define estilos de bloqueio
            practicalTab.style.opacity = '0.5';
            practicalTab.style.cursor = 'not-allowed';
            
            console.log('üîí Aba Atividade Pr√°tica bloqueada');
        }

        function showNextLessonButton() {
            nextLessonBtn.classList.remove('hidden');
            nextLessonBtn.classList.add('visible');
        }

        function hideNextLessonButton() {
            nextLessonBtn.classList.add('hidden');
            nextLessonBtn.classList.remove('visible');
        }

        function lockNextLessonButton() {
            nextLessonBtn.disabled = true;
            const lockIndicator = nextLessonBtn.querySelector('.next-lesson-lock-indicator');
            if (lockIndicator) {
                lockIndicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
            }
            nextLessonBtn.style.opacity = '0.5';
            console.log('üîí Bot√£o "Pr√≥xima Aula" bloqueado');
        }

        function unlockNextLessonButton() {
            nextLessonBtn.disabled = false;
            const lockIndicator = nextLessonBtn.querySelector('.next-lesson-lock-indicator');
            if (lockIndicator) {
                lockIndicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle></svg>';
            }
            nextLessonBtn.style.opacity = '1';
            console.log('üîì Bot√£o "Pr√≥xima Aula" desbloqueado');
        }

        // CORRE√á√ÉO: Move ensureCorrectTabIsActive para escopo global para evitar erro de refer√™ncia
        window.ensureCorrectTabIsActive = function() {
            console.log('üîÑ Verificando qual aba deve estar ativa baseada no conte√∫do atual');
            
            // Verifica qual conte√∫do est√° vis√≠vel
            const videoContent = document.getElementById('video-content');
            const exerciseContent = document.getElementById('exercise-content');
            const practicalContent = document.getElementById('practical-content');
            
            let activeTabId = 'video-tab'; // Padr√£o
            
            if (videoContent && videoContent.classList.contains('active')) {
                activeTabId = 'video-tab';
                console.log('üì∫ Conte√∫do ativo: v√≠deo');
            } else if (exerciseContent && exerciseContent.classList.contains('active')) {
                activeTabId = 'exercise-tab';
                console.log('üìù Conte√∫do ativo: exerc√≠cio');
            } else if (practicalContent && practicalContent.classList.contains('active')) {
                activeTabId = 'practical-tab';
                console.log('üîß Conte√∫do ativo: atividade pr√°tica');
            }
            
            // Remove active de todas as abas
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            
            // Ativa a aba correspondente
            const activeTab = document.getElementById(activeTabId);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.setAttribute('aria-selected', 'true');
                console.log('‚úÖ Aba sincronizada:', activeTabId);
            }
        };

        // CORRE√á√ÉO: Move updateButtonStates para escopo global para evitar erro de refer√™ncia
        window.updateButtonStates = function(lessonTitle, activeIcon) {
            const p = userProgress[lessonTitle] || {};
            console.log('üîß updateButtonStates - progress:', p, 'lessonTitle:', lessonTitle);

            // FLUXO CORRETO: V√≠deo 90% ‚Üí Exerc√≠cio ‚Üí Atividade Pr√°tica ‚Üí Enviar Atividade Pr√°tica ‚Üí Pr√≥xima Aula

            // 1. Tab Exerc√≠cio - desbloqueia se v√≠deo foi assistido (90%+)
            if (p.videoCompleted) {
                unlockExerciseTab();
                console.log('‚úÖ Exerc√≠cio desbloqueado (v√≠deo 90%+)');
            } else {
                lockExerciseTab();
                console.log('üîí Exerc√≠cio bloqueado (v√≠deo < 90%)');
            }

            // 2. Tab Atividade Pr√°tica - desbloqueia se exerc√≠cio foi completado (100%)
            if (typeof unlockPracticalTab === 'function') {
                if (p.exerciseCompleted) {
                    console.log('üîì updateButtonStates: Desbloqueando Atividade Pr√°tica');
                    unlockPracticalTab();
                    console.log('‚úÖ Atividade Pr√°tica desbloqueada (exerc√≠cio 100%)');
                } else {
                    console.log('üîí updateButtonStates: Bloqueando Atividade Pr√°tica');
                    lockPracticalTab();
                    console.log('üîí Atividade Pr√°tica bloqueada (exerc√≠cio < 100%)');
                }
            } else {
                console.log('‚ùå updateButtonStates: unlockPracticalTab n√£o √© uma fun√ß√£o');
            }

            // 3. Bot√£o Pr√≥xima Aula - desbloqueia se atividade pr√°tica foi enviada
            // FLUXO CORRETO: Video 90% + Exerc√≠cio 100% + Atividade Pr√°tica Enviada
            // CORRE√á√ÉO: Verifica se realmente foi enviada (n√£o apenas desbloqueada)
            const canShow = !!(p.videoCompleted && p.exerciseCompleted && p.practicalSubmitted && p.practicalSubmitted === true);
            console.log('üîç updateButtonStates - canShow Pr√≥xima Aula:', canShow, 'progress:', p);
            
            if (canShow) {
                showNextLessonButton();
                unlockNextLessonButton();
                console.log('‚úÖ Bot√£o "Pr√≥xima Aula" mostrado e desbloqueado (atividade pr√°tica enviada)');
                
                // Scroll autom√°tico para o bot√£o quando ele aparece
                setTimeout(() => {
                    if (nextLessonBtn && !nextLessonBtn.classList.contains('hidden')) {
                        nextLessonBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        console.log('üìú Scroll autom√°tico para bot√£o "Pr√≥xima Aula"');
                    }
                }, 300);
            } else {
                hideNextLessonButton();
                console.log('‚ùå Bot√£o "Pr√≥xima Aula" oculto - atividade pr√°tica n√£o enviada');
            }
        };
        
        // Atualiza o contador de progresso de um t√≥pico
        function updateTopicProgress(accordionElement) {
            // N√£o atualiza t√≥picos bloqueados (locked-topic)
            if (accordionElement.classList.contains('locked-topic')) {
                return;
            }
            
            const progressSpan = accordionElement.querySelector('.topic-progress');
            const lessons = accordionElement.querySelectorAll('.lesson-list li');
            const completedLessons = accordionElement.querySelectorAll('.lesson-icon.completed');
            
            progressSpan.textContent = `${completedLessons.length}/${lessons.length}`;
        }

        // Verifica se pode desbloquear pr√≥xima aula
        function unlockNextLesson(currentLessonTitle) {
            console.log('üîì unlockNextLesson chamada para:', currentLessonTitle);
            
            try {
                const currentLessonLink = document.querySelector(`.lesson-list a.active`);
                if (!currentLessonLink) {
                    console.error('‚ùå currentLessonLink n√£o encontrado');
                    return;
                }
                
                const currentListItem = currentLessonLink.parentElement;
                if (!currentListItem) {
                    console.error('‚ùå currentListItem n√£o encontrado');
                    return;
                }
                
                const nextListItem = currentListItem.nextElementSibling;
                console.log('üìã Pr√≥xima aula encontrada:', !!nextListItem);
                
                if (nextListItem && nextListItem.classList.contains('lesson-locked')) {
                    const nextLessonLink = nextListItem.querySelector('a');
                    const allSpans = nextLessonLink.querySelectorAll('span');
                    let titleSpan = null;
                    for (let span of allSpans) {
                        if (!span.classList.contains('lesson-duration') && !span.classList.contains('lesson-icon')) {
                            titleSpan = span;
                            break;
                        }
                    }
                    const nextLessonTitle = titleSpan ? titleSpan.textContent : 'Aula sem t√≠tulo';
                    console.log('üìù Pr√≥xima aula:', nextLessonTitle);
                    
                    // Desbloqueia pr√≥xima aula se a atual foi conclu√≠da
                    console.log('üìä Verificando progresso da aula atual:', userProgress[currentLessonTitle]);
                    
                    if (userProgress[currentLessonTitle] && userProgress[currentLessonTitle].completed) {
                        console.log('‚úÖ Aula atual conclu√≠da - desbloqueando pr√≥xima aula');
                        
                        // Remove classe de bloqueio e adiciona classe de desbloqueio
                        nextListItem.classList.remove('lesson-locked');
                        nextListItem.classList.add('lesson-unlocked');
                        
                        // Remove o √≠cone de cadeado e adiciona √≠cone padr√£o
                        const lockIcon = nextListItem.querySelector('svg');
                        if (lockIcon) {
                            lockIcon.remove();
                            console.log('üîì √çcone de cadeado removido');
                        }
                        
                        // Adiciona o √≠cone padr√£o de aula
                        const iconSpan = document.createElement('span');
                        iconSpan.className = 'lesson-icon todo';
                        nextLessonLink.insertBefore(iconSpan, nextLessonLink.firstChild);
                        
                        console.log('‚úÖ Pr√≥xima aula desbloqueada com sucesso');
                    } else {
                        console.log('‚ùå Aula atual n√£o est√° marcada como conclu√≠da no userProgress');
                    }
                } else {
                    console.log('‚ÑπÔ∏è Pr√≥xima aula n√£o est√° bloqueada ou n√£o existe');
                }
            } catch (error) {
                console.error('‚ùå Erro em unlockNextLesson:', error);
                throw error;
            }
        }

        // Reseta o formul√°rio de exerc√≠cios
        function resetExerciseForm() {
            if (exerciseForm) {
                exerciseForm.reset();
                exerciseFeedback.textContent = '';
                exerciseFeedback.className = '';
                exerciseFeedback.innerHTML = '';
                
                // Remove quaisquer estilos aplicados anteriormente
                document.querySelectorAll('.exercise-question').forEach(question => {
                    question.classList.remove('correct', 'incorrect', 'partial-correct');
                });
            }
        }

        // Verifica as respostas do exerc√≠cio
        function checkExerciseAnswers(lessonTitle) {
            const lessonInfo = lessonData[lessonTitle];
            if (!lessonInfo || !lessonInfo.correctAnswers) {
                return { score: 0, total: 0, allCorrect: false, details: [] };
            }
            const correctAnswers = lessonInfo.correctAnswers;
            const details = [];
            let score = 0;
            let total = 0;
            for (const q in correctAnswers) {
                total++;
                const answer = correctAnswers[q];
                const selected = document.querySelector(`input[name="${q}"]:checked`);
                const isCorrect = selected && selected.value === answer;
                if (isCorrect) score++;
                details.push({ question: q, correctAnswer: answer, selectedAnswer: selected ? selected.value : null, isCorrect });
            }
            return { score, total, allCorrect: score === total, details };
        }

        // Gera feedback detalhado para cada quest√£o
        function generateDetailedFeedback(lessonTitle, result) {
            const lessonInfo = lessonData[lessonTitle];
            if (!lessonInfo || !lessonInfo.explanations) {
                return `<div class="exercise-feedback">Sem explica√ß√µes detalhadas dispon√≠veis.</div>`;
            }
            let feedbackHTML = `<div class="exercise-feedback">`;
            result.details.forEach((detail, index) => {
                const qNum = index + 1;
                const explanation = lessonInfo.explanations[`q${qNum}`];
                const statusClass = detail.isCorrect ? 'correct' : (detail.selectedAnswer ? 'incorrect' : 'neutral');
                feedbackHTML += `<div class="question-feedback ${statusClass}">`;
                feedbackHTML += `<h4>Quest√£o ${qNum}</h4>`;
                if (detail.isCorrect) {
                    feedbackHTML += `<p class="result">‚úÖ Correta</p>`;
                    if (explanation && explanation.correct) feedbackHTML += `<p class="explanation">${explanation.correct}</p>`;
                } else if (detail.selectedAnswer) {
                    feedbackHTML += `<p class="result">‚ùå Incorreta</p>`;
                    const wrongExp = explanation && explanation.incorrect && explanation.incorrect[detail.selectedAnswer];
                    if (wrongExp) feedbackHTML += `<p class="explanation">${wrongExp}</p>`;
                } else {
                    feedbackHTML += `<p class="result">‚ö†Ô∏è N√£o respondida</p>`;
                }
                feedbackHTML += `</div>`;
            });
            
            // Feedback geral
            if (result.allCorrect) {
                feedbackHTML += `<div class="feedback-header success">üéâ Parab√©ns! Voc√™ acertou todas as ${result.total} quest√µes!</div>`;
            } else {
                feedbackHTML += `<div class="feedback-header ${result.score > 0 ? 'partial' : 'error'}">`;
                feedbackHTML += `Voc√™ acertou ${result.score} de ${result.total} quest√µes.`;
                if (result.score > 0) {
                    feedbackHTML += ` Continue estudando para acertar todas!`;
                }
                feedbackHTML += `</div>`;
            }
            
            feedbackHTML += `</div>`;
            return feedbackHTML;
        }

        // Obt√©m o texto da resposta baseado no valor
        function getAnswerText(question, value) {
            const questionElement = document.querySelector(`input[name="${question}"][value="${value}"]`);
            if (questionElement) {
                return questionElement.parentElement.textContent.trim();
            }
            return '';
        }


        // --- EVENT LISTENERS ---

        // Carrega a primeira aula ao entrar na p√°gina
        const firstLesson = document.querySelector('.lesson-list a.active');
        if (firstLesson) {
            console.log('üé¨ Carregando primeira aula:', firstLesson);
            loadLesson(firstLesson, true); // isInitialLoad = true para n√£o limpar estado salvo
        } else {
            console.error('‚ùå Nenhuma aula ativa encontrada');
        }

        // Adiciona evento de clique para cada link de aula
        lessonLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                
                // Verifica se a aula est√° bloqueada
                const listItem = this.parentElement;
                if (listItem.classList.contains('lesson-locked')) {
                    alert('Complete a aula anterior para desbloquear esta aula.');
                    return;
                }
                
                loadLesson(this);
            });
        });


        // Event listeners para as tabs
        videoTab.addEventListener('click', function() {
            switchTab('video');
        });

        exerciseTab.addEventListener('click', function() {
            switchTab('exercise');
            
            // CORRE√á√ÉO: Restaura o estado do exerc√≠cio sempre que a aba √© aberta
            setTimeout(() => {
                if (typeof window.restoreExerciseState === 'function') {
                    console.log('üîÑ Restaurando estado do exerc√≠cio ao abrir aba...');
                    window.restoreExerciseState();
                }
            }, 300);
        });

        if (practicalTab) {
            practicalTab.addEventListener('click', function() {
                switchTab('practical');
            });
        }

        // Atalhos de teclado para navega√ß√£o entre tabs
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === '1') {
                e.preventDefault();
                switchTab('video');
            }
            if (e.ctrlKey && e.key === '2') {
                e.preventDefault();
                switchTab('exercise');
            }
            if (e.ctrlKey && e.key === '3') {
                e.preventDefault();
                switchTab('practical');
            }
        });

        // Evento de clique no bot√£o de pr√≥xima aula
        nextLessonBtn.addEventListener('click', function(event) {
            event.preventDefault();
            const activeLessonLink = document.querySelector('.lesson-list a.active');
            if (!activeLessonLink) return;
            
            const currentListItem = activeLessonLink.parentElement;
            const nextListItem = currentListItem.nextElementSibling;
            
            // FLUXO CORRETO: MARCA A AULA ATUAL COMO CONCLU√çDA AUTOMATICAMENTE ANTES DE NAVEGAR
            const titleSpan = activeLessonLink.querySelector('span:not(.lesson-duration):not(.lesson-icon)');
            const currentLessonTitle = titleSpan ? titleSpan.textContent.trim() : '';
            
            if (currentLessonTitle) {
                console.log('üéØ FLUXO CORRETO: Marcando aula como conclu√≠da automaticamente:', currentLessonTitle);
                console.log('üìä Estado atual antes da atualiza√ß√£o:', userProgress[currentLessonTitle]);
                
                // FLUXO CORRETO: Marca como conclu√≠da automaticamente ao clicar em "Pr√≥xima Aula"
                updateUserProgress(currentLessonTitle, { 
                    completed: true,
                    fullyCompleted: true,
                    completedAt: new Date().toISOString()
                });
                
                console.log('üìä Estado ap√≥s atualiza√ß√£o:', userProgress[currentLessonTitle]);
                
                // Atualiza o √≠cone da aula atual para "completed"
                const activeIcon = activeLessonLink.querySelector('.lesson-icon');
                if (activeIcon) {
                    activeIcon.className = 'lesson-icon completed';
                    console.log('‚úÖ √çcone da aula atual atualizado para "completed"');
                }
                
                // Atualiza o estado dos bot√µes
                if (typeof window.updateButtonStates === 'function') {
                    window.updateButtonStates(currentLessonTitle);
                }
                
                // CORRE√á√ÉO CR√çTICA: Garantir que unlockNextLesson seja chamada
                try {
                    console.log('üîì Chamando unlockNextLesson para:', currentLessonTitle);
                    console.log('üìä Estado do progresso antes de desbloquear:', userProgress[currentLessonTitle]);
                    
                    // Desbloqueia a pr√≥xima aula ap√≥s marcar como conclu√≠da
                    unlockNextLesson(currentLessonTitle);
                    
                    console.log('‚úÖ unlockNextLesson executada com sucesso');
                    
                    // Fallback: for√ßa atualiza√ß√£o do progresso do t√≥pico
                    const accordions = document.querySelectorAll('.topic-accordion');
                    accordions.forEach(accordion => {
                        updateTopicProgress(accordion);
                    });
                } catch (error) {
                    console.error('‚ùå Erro em unlockNextLesson:', error);
                    
                    // Fallback: atualiza progresso do t√≥pico manualmente
                    const accordions = document.querySelectorAll('.topic-accordion');
                    accordions.forEach(accordion => {
                        updateTopicProgress(accordion);
                    });
                }
            }
            
            if (nextListItem) {
                const nextLessonLink = nextListItem.querySelector('a');
                
                // FLUXO CORRETO: Navega para pr√≥xima aula e reinicia o ciclo
                console.log('üîÑ Navegando para pr√≥xima aula e reiniciando ciclo...');
                loadLesson(nextLessonLink);
            } else {
                alert('N√£o h√° mais aulas neste t√≥pico.');
            }
        });

        // Evento: Toggle Viewer do Google Docs
        if (toggleDocsViewerBtn && docsViewer) {
            toggleDocsViewerBtn.addEventListener('click', function() {
                if (docsViewer.style.display === 'none' || !docsViewer.style.display) {
                    docsViewer.style.display = 'block';
                    toggleDocsViewerBtn.innerHTML = 'üîº Ocultar Visualiza√ß√£o';
                } else {
                    docsViewer.style.display = 'none';
                    toggleDocsViewerBtn.innerHTML = 'üëÅÔ∏è Visualizar Aqui';
                }
            });
        }

        // Evento: Toggle Viewer do PDF
        if (togglePdfViewerBtn && pdfViewer) {
            togglePdfViewerBtn.addEventListener('click', function() {
                if (pdfViewer.style.display === 'none' || !pdfViewer.style.display) {
                    pdfViewer.style.display = 'block';
                    togglePdfViewerBtn.innerHTML = 'üîº Ocultar PDF';
                    
                    // Registra progresso quando visualiza o material
                    if (currentLessonTitle) {
                        updateUserProgress(currentLessonTitle, { modelDownloaded: true });
                        console.log('üì• Material visualizado');
                    }
                } else {
                    pdfViewer.style.display = 'none';
                    togglePdfViewerBtn.innerHTML = 'üëÅÔ∏è Visualizar PDF';
                }
            });
        }

        // Integra√ß√£o com Draw.io (postMessage) - VERS√ÉO MELHORADA
        window.addEventListener('message', function(evt) {
            try {
                if (!evt || !evt.data) return;
                const msg = JSON.parse(evt.data);
                
                console.log('üì® Mensagem recebida do draw.io:', msg.event || 'unknown');
                
                if (msg.event === 'init') {
                    // Sinaliza pronto e processa fila
                    console.log('üéâ Editor draw.io inicializado com sucesso!');
                    editorReady = true;
                    editorRetries = 0;
                    
                    // Limpa timeout de carregamento
                    if (editorLoadTimeout) {
                        clearTimeout(editorLoadTimeout);
                        editorLoadTimeout = null;
                    }
                    
                    if (editorStatus) editorStatus.textContent = 'Editor pronto';
                    drainEditorQueue();
                } else if (msg.event === 'export') {
                    console.log('üì§ Diagrama exportado pelo usu√°rio');
                    currentDiagramData.image = 'data:image/png;base64,' + msg.data;
                    if (typeof msg.xml === 'string') currentDiagramData.xml = msg.xml;
                    if (diagramThumbnail) diagramThumbnail.src = currentDiagramData.image;
                    if (savedWorkPreview) savedWorkPreview.classList.remove('hidden');
                    if (submitPracticalBtn) submitPracticalBtn.disabled = false;
                    if (editorStatus) editorStatus.textContent = 'Diagrama salvo';
                } else if (msg.event === 'load') {
                    // Confirma carregamento de template
                    console.log('üìÑ Template carregado com sucesso');
                    if (editorStatus) editorStatus.textContent = 'Template carregado!';
                } else if (msg.event === 'save') {
                    // Captura dados do diagrama salvo
                    console.log('üíæ Diagrama salvo pelo usu√°rio');
                    currentDiagramData.xml = msg.xml;
                    currentDiagramData.image = msg.data;
                    updateUserProgress(currentLessonTitle, { diagramSaved: true });
                } else if (msg.event === 'error') {
                    // Trata erros do editor
                    console.error('‚ùå Erro no editor draw.io:', msg.message || 'Erro desconhecido');
                    if (editorStatus) editorStatus.textContent = 'Erro no editor';
                }
                // Sem carregamento autom√°tico de template neste modo
            } catch (e) {
                // Ignora mensagens externas n√£o-JSON (normal para outras origens)
            }
        });

        // Solicita export do diagrama (salvar)
        // Bot√£o de salvar desativado no modo atual (export pelo menu do editor)

        // Templates m√≠nimos por tipo
        const UML_TEMPLATES = {
            'classes': `<?xml version="1.0" encoding="UTF-8"?>\
<mxfile host=\"app.diagrams.net\"><diagram id=\"CLASSES\" name=\"Classes\"><mxGraphModel dx=\"1062\" dy=\"609\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"1169\" pageHeight=\"827\" math=\"0\" shadow=\"0\"><root><mxCell id=\"0\"/><mxCell id=\"1\" parent=\"0\"/><mxCell id=\"2\" value=\"ClasseA\" style=\"shape=umlClass;align=left;verticalAlign=top;spacingLeft=10;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"120\" y=\"150\" width=\"160\" height=\"120\" as=\"geometry\"/></mxCell><mxCell id=\"3\" value=\"ClasseB\" style=\"shape=umlClass;align=left;verticalAlign=top;spacingLeft=10;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"380\" y=\"150\" width=\"160\" height=\"120\" as=\"geometry\"/></mxCell><mxCell id=\"4\" edge=\"1\" parent=\"1\" source=\"2\" target=\"3\" style=\"endArrow=block;endFill=1;\"><mxGeometry relative=\"1\" as=\"geometry\"/></mxCell></root></mxGraphModel></diagram></mxfile>`,
            'casos-uso': `<?xml version="1.0" encoding="UTF-8"?>\
<mxfile host=\"app.diagrams.net\"><diagram id=\"USECASE\" name=\"Casos de Uso\"><mxGraphModel dx=\"1062\" dy=\"609\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"1169\" pageHeight=\"827\" math=\"0\" shadow=\"0\"><root><mxCell id=\"0\"/><mxCell id=\"1\" parent=\"0\"/><mxCell id=\"2\" value=\"Ator\" style=\"shape=umlActor;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"120\" y=\"160\" width=\"40\" height=\"80\" as=\"geometry\"/></mxCell><mxCell id=\"3\" value=\"Caso de Uso\" style=\"shape=ellipse;whiteSpace=wrap;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"300\" y=\"170\" width=\"160\" height=\"60\" as=\"geometry\"/></mxCell><mxCell id=\"4\" edge=\"1\" parent=\"1\" source=\"2\" target=\"3\"><mxGeometry relative=\"1\" as=\"geometry\"/></mxCell></root></mxGraphModel></diagram></mxfile>`,
            'sequencia': `<?xml version="1.0" encoding="UTF-8"?>\
<mxfile host=\"app.diagrams.net\"><diagram id=\"SEQ\" name=\"Sequencia\"><mxGraphModel dx=\"1062\" dy=\"609\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"1169\" pageHeight=\"827\" math=\"0\" shadow=\"0\"><root><mxCell id=\"0\"/><mxCell id=\"1\" parent=\"0\"/><mxCell id=\"2\" value=\"A\" style=\"shape=umlLifeline;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"160\" y=\"120\" width=\"100\" height=\"300\" as=\"geometry\"/></mxCell><mxCell id=\"3\" value=\"B\" style=\"shape=umlLifeline;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"380\" y=\"120\" width=\"100\" height=\"300\" as=\"geometry\"/></mxCell><mxCell id=\"4\" edge=\"1\" parent=\"1\" source=\"2\" target=\"3\" style=\"endArrow=open;dashed=0;\"><mxGeometry relative=\"1\" as=\"geometry\"/></mxCell></root></mxGraphModel></diagram></mxfile>`,
            'atividades': `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\
<mxfile host=\"app.diagrams.net\"><diagram id=\"ACT\" name=\"Atividades\"><mxGraphModel dx=\"1062\" dy=\"609\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"1169\" pageHeight=\"827\" math=\"0\" shadow=\"0\"><root><mxCell id=\"0\"/><mxCell id=\"1\" parent=\"0\"/><mxCell id=\"2\" value=\"In√≠cio\" style=\"shape=ellipse;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"150\" y=\"150\" width=\"60\" height=\"60\" as=\"geometry\"/></mxCell><mxCell id=\"3\" value=\"A√ß√£o\" style=\"shape=process;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"280\" y=\"150\" width=\"120\" height=\"60\" as=\"geometry\"/></mxCell><mxCell id=\"4\" edge=\"1\" parent=\"1\" source=\"2\" target=\"3\" style=\"endArrow=block;\"><mxGeometry relative=\"1\" as=\"geometry\"/></mxCell></root></mxGraphModel></diagram></mxfile>`,
            'estados': `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\
<mxfile host=\"app.diagrams.net\"><diagram id=\"STATE\" name=\"Estados\"><mxGraphModel dx=\"1062\" dy=\"609\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"1169\" pageHeight=\"827\" math=\"0\" shadow=\"0\"><root><mxCell id=\"0\"/><mxCell id=\"1\" parent=\"0\"/><mxCell id=\"2\" value=\"Estado A\" style=\"shape=umlState;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"160\" y=\"160\" width=\"160\" height=\"80\" as=\"geometry\"/></mxCell><mxCell id=\"3\" value=\"Estado B\" style=\"shape=umlState;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"380\" y=\"160\" width=\"160\" height=\"80\" as=\"geometry\"/></mxCell><mxCell id=\"4\" edge=\"1\" parent=\"1\" source=\"2\" target=\"3\" style=\"endArrow=block;\"><mxGeometry relative=\"1\" as=\"geometry\"/></mxCell></root></mxGraphModel></diagram></mxfile>`,
            'componentes': `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\
<mxfile host=\"app.diagrams.net\"><diagram id=\"COMP\" name=\"Componentes\"><mxGraphModel dx=\"1062\" dy=\"609\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"1169\" pageHeight=\"827\" math=\"0\" shadow=\"0\"><root><mxCell id=\"0\"/><mxCell id=\"1\" parent=\"0\"/><mxCell id=\"2\" value=\"Componente A\" style=\"shape=component;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"180\" y=\"160\" width=\"140\" height=\"80\" as=\"geometry\"/></mxCell><mxCell id=\"3\" value=\"Componente B\" style=\"shape=component;\" vertex=\"1\" parent=\"1\"><mxGeometry x=\"380\" y=\"160\" width=\"140\" height=\"80\" as=\"geometry\"/></mxCell><mxCell id=\"4\" edge=\"1\" parent=\"1\" source=\"2\" target=\"3\" style=\"endArrow=block;endFill=1;\"><mxGeometry relative=\"1\" as=\"geometry\"/></mxCell></root></mxGraphModel></diagram></mxfile>`
        };

        // Recarrega editor com libs apropriadas e template m√≠nimo - VERS√ÉO MELHORADA
        if (umlDiagramTypeSelect && umlEditorIframe) {
            umlDiagramTypeSelect.addEventListener('change', async function() {
                const value = umlDiagramTypeSelect.value;
                
                if (!value) {
                    console.log('‚ö†Ô∏è Nenhum tipo selecionado');
                    return;
                }
                
                console.log('üéØ Tipo selecionado:', value);
                const libs = 'uml;general';
                
                try {
                    // Atualiza status
                    if (editorStatus) editorStatus.textContent = 'Preparando editor...';
                    
                    // Recarrega editor com cache-buster
                    const editorUrl = `https://embed.diagrams.net/?embed=1&ui=kennedy&lang=pt-BR&noSaveBtn=1&noExitBtn=1&proto=json&libs=${encodeURIComponent(libs)}&grid=1&nav=1&shadow=0&splash=0`;
                    setEditorSrc(editorUrl);
                    
                    // Aguarda editor ficar pronto
                    const ok = await ensureEditorReadyWithRetry();
                    
                    if (ok) {
                        console.log('‚úÖ Editor pronto, carregando template...');
                        if (editorStatus) editorStatus.textContent = 'Carregando template...';
                        
                        const xml = UML_TEMPLATES[value];
                        if (xml) {
                            // Aguarda um pouco antes de enviar o template
                            setTimeout(() => {
                                sendToEditor({ 
                                    action: 'load', 
                                    xml: xml, 
                                    autosave: 1, 
                                    spin: 'Carregando template...' 
                                });
                                
                                if (editorStatus) editorStatus.textContent = 'Template carregado!';
                                console.log('üé® Template', value, 'carregado com sucesso!');
                            }, 500);
                        } else {
                            console.error('‚ùå Template n√£o encontrado para:', value);
                            if (editorStatus) editorStatus.textContent = 'Template n√£o encontrado';
                        }
                    } else {
                        console.error('‚ùå Falha ao carregar editor');
                        if (editorStatus) editorStatus.textContent = 'Falha ao carregar editor';
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao recarregar editor:', e);
                    if (editorStatus) editorStatus.textContent = 'Erro no carregamento';
                }
            });
        }

        // Bot√£o de teste de conex√£o
        const testEditorBtn = document.getElementById('test-editor-btn');
        if (testEditorBtn) {
            testEditorBtn.addEventListener('click', async function() {
                console.log('üß™ Testando conex√£o com draw.io...');
                
                if (editorStatus) editorStatus.textContent = 'Testando conex√£o...';
                
                try {
                    // Testa se o editor est√° pronto
                    if (editorReady && umlEditorIframe && umlEditorIframe.contentWindow) {
                        // Envia mensagem de teste
                        sendToEditor({ 
                            action: 'test', 
                            message: 'Teste de conex√£o' 
                        });
                        
                        if (editorStatus) editorStatus.textContent = 'Conex√£o OK!';
                        console.log('‚úÖ Conex√£o com draw.io funcionando!');
                    } else {
                        // Tenta recarregar o editor
                        console.log('üîÑ Editor n√£o pronto, recarregando...');
                        setEditorSrc(EDITOR_BASE_URL);
                        
                        const ok = await ensureEditorReadyWithRetry();
                        if (ok) {
                            if (editorStatus) editorStatus.textContent = 'Conex√£o restaurada!';
                            console.log('‚úÖ Editor recarregado com sucesso!');
                        } else {
                            if (editorStatus) editorStatus.textContent = 'Falha na conex√£o';
                            console.error('‚ùå Falha ao conectar com draw.io');
                        }
                    }
                } catch (e) {
                    console.error('‚ùå Erro no teste de conex√£o:', e);
                    if (editorStatus) editorStatus.textContent = 'Erro no teste';
                }
            });
        }

        // Modo livre: sem template pr√©-carregado
        // Controle do upload de arquivo com pr√©-visualiza√ß√£o melhorada
        let selectedFile = null;
        const fileUploadArea = document.getElementById('file-upload-area');
        const filePreviewArea = document.getElementById('file-preview-area');
        const filePreviewContent = document.getElementById('file-preview-content');
        const fileInfo = document.getElementById('file-info');
        const removeFileBtn = document.getElementById('remove-file-btn');

        // Fun√ß√£o para formatar tamanho do arquivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Fun√ß√£o para obter √≠cone do tipo de arquivo
        function getFileTypeIcon(fileType) {
            if (fileType.startsWith('image/')) return 'üñºÔ∏è';
            if (fileType === 'application/pdf') return 'üìÑ';
            if (fileType.includes('svg')) return 'üé®';
            return 'üìÅ';
        }

        // Fun√ß√£o para criar pr√©-visualiza√ß√£o
        function createFilePreview(file) {
            const fileType = file.type;
            const fileName = file.name;
            const fileSize = formatFileSize(file.size);
            const fileIcon = getFileTypeIcon(fileType);

            // Criar informa√ß√µes do arquivo
            fileInfo.innerHTML = `
                <div class="file-info-item">
                    <span class="file-info-label">Nome:</span>
                    <span class="file-info-value">${fileName}</span>
                </div>
                <div class="file-info-item">
                    <span class="file-info-label">Tamanho:</span>
                    <span class="file-info-value">${fileSize}</span>
                </div>
                <div class="file-info-item">
                    <span class="file-info-label">Tipo:</span>
                    <span class="file-info-value">${fileType || 'Desconhecido'}</span>
                </div>
            `;

            // Criar pr√©-visualiza√ß√£o baseada no tipo
            if (fileType.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    filePreviewContent.innerHTML = `
                        <img src="${e.target.result}" alt="Pr√©-visualiza√ß√£o de ${fileName}" />
                    `;
                };
                reader.readAsDataURL(file);
            } else if (fileType === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    filePreviewContent.innerHTML = `
                        <iframe src="${e.target.result}#toolbar=0&navpanes=0&scrollbar=0" 
                                title="Pr√©-visualiza√ß√£o de ${fileName}">
                        </iframe>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                filePreviewContent.innerHTML = `
                    <div>
                        <div class="file-type-icon">${fileIcon}</div>
                        <h4>${fileName}</h4>
                        <p>Arquivo selecionado com sucesso!</p>
                        <small>Pr√©-visualiza√ß√£o n√£o dispon√≠vel para este tipo de arquivo.</small>
                    </div>
                `;
            }
        }

        // Event listeners para upload
        if (diagramFileInput) {
            diagramFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validar tamanho (10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('Arquivo muito grande! Tamanho m√°ximo: 10MB');
                        return;
                    }

                    selectedFile = file;
                    
                    // Ocultar √°rea de upload e mostrar pr√©-visualiza√ß√£o
                    fileUploadArea.style.display = 'none';
                    filePreviewArea.classList.remove('hidden');
                    
                    // Criar pr√©-visualiza√ß√£o
                    createFilePreview(file);

                    // Marca diagrama como salvo quando arquivo √© selecionado
                    updateUserProgress(currentLessonTitle, { diagramSaved: true });

                    if (submitPracticalBtn) submitPracticalBtn.disabled = false;
                    console.log('üìÅ Arquivo selecionado e diagrama marcado como salvo');

                    // Exibe modal de confirma√ß√£o
                    if (fileUploadModal) {
                        fileUploadModal.classList.remove('hidden');
                        fileUploadModal.setAttribute('aria-hidden', 'false');
                    }
                } else {
                    selectedFile = null;
                    if (fileStatus) fileStatus.textContent = 'Nenhum arquivo selecionado';
                    if (submitPracticalBtn) submitPracticalBtn.disabled = true;
                }
            });
        }

        // Event listener para remover arquivo
        if (removeFileBtn) {
            removeFileBtn.addEventListener('click', function() {
                selectedFile = null;
                diagramFileInput.value = '';
                
                // Mostrar √°rea de upload e ocultar pr√©-visualiza√ß√£o
                fileUploadArea.style.display = 'block';
                filePreviewArea.classList.add('hidden');
                
                if (submitPracticalBtn) submitPracticalBtn.disabled = true;
                console.log('üìÅ Arquivo removido');
            });
        }

        // Drag and drop
        if (fileUploadArea) {
            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    diagramFileInput.files = files;
                    diagramFileInput.dispatchEvent(new Event('change'));
                }
            });
        }

        // Fecha modal ao clicar em OK
        if (fileUploadOkBtn && fileUploadModal) {
            fileUploadOkBtn.addEventListener('click', function() {
                fileUploadModal.classList.add('hidden');
                fileUploadModal.setAttribute('aria-hidden', 'true');
            });
        }

        // Envio da Atividade
        if (submitPracticalBtn) {
            submitPracticalBtn.addEventListener('click', function() {
                if (!currentLessonTitle) return;
                if (!selectedFile) {
                    alert('Selecione um arquivo antes de enviar.');
                    return;
                }
                // FLUXO CORRETO: Marca atividade como enviada (mas N√ÉO conclui a aula ainda)
                updateUserProgress(currentLessonTitle, { 
                    practicalSubmitted: true, 
                    practicalCompleted: true
                });

                // Feedback visual da pr√°tica
                if (practicalFeedback) practicalFeedback.classList.remove('hidden');

                // Mostra e desbloqueia o bot√£o do cabe√ßalho
                console.log('üéØ Enviando atividade - desbloqueando bot√£o "Pr√≥xima Aula"');
                if (typeof showNextLessonButton === 'function') {
                    showNextLessonButton();
                    console.log('‚úÖ Bot√£o "Pr√≥xima Aula" mostrado');
                }
                if (typeof unlockNextLessonButton === 'function') {
                    unlockNextLessonButton();
                    console.log('‚úÖ Bot√£o "Pr√≥xima Aula" desbloqueado');
                }

                // Garante que o bot√£o de pr√≥xima aula no feedback permane√ßa oculto
                if (feedbackNextLessonBtn) {
                    feedbackNextLessonBtn.classList.add('hidden');
                    feedbackNextLessonBtn.style.display = 'none';
                }

                // Atualiza o estado dos bot√µes ap√≥s o envio
                if (typeof window.updateButtonStates === 'function') {
                    console.log('üîÑ Atualizando estado dos bot√µes ap√≥s envio da atividade');
                    window.updateButtonStates(currentLessonTitle);
                }

                // Rola automaticamente at√© o bot√£o do cabe√ßalho
                setTimeout(() => {
                    if (nextLessonBtn && !nextLessonBtn.disabled) {
                        nextLessonBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        console.log('üìú Scroll autom√°tico para bot√£o "Pr√≥xima Aula"');
                    }
                }, 200);
            });
        }

        // Evento para o bot√£o de pr√≥xima aula no feedback (movido para o final para garantir que nextLessonBtn esteja dispon√≠vel)
        setTimeout(() => {
            // Se o bot√£o de feedback n√£o existir no DOM, cria um fallback simples para garantir a a√ß√£o
            if (!feedbackNextLessonBtn) {
                try {
                    console.warn('‚ö†Ô∏è feedbackNextLessonBtn n√£o encontrado ‚Äî criando fallback dinamicamente');
                    const fb = document.createElement('button');
                    fb.id = 'feedback-next-lesson-btn';
                    fb.className = 'button button-primary';
                    fb.textContent = 'Pr√≥xima Aula';
                    fb.style.marginTop = '0.75rem';
                    // Insere dentro do container de feedback do exerc√≠cio se poss√≠vel
                    const container = document.getElementById('exercise-feedback') || document.getElementById('practical-feedback') || document.body;
                    container.appendChild(fb);
                    feedbackNextLessonBtn = fb;
                    console.log('üî® Fallback feedbackNextLessonBtn criado');
                } catch (e) {
                    console.error('‚ùå Falha ao criar fallback para feedbackNextLessonBtn:', e);
                }
            }

            if (feedbackNextLessonBtn && nextLessonBtn) {
                feedbackNextLessonBtn.addEventListener('click', function() {
                    console.log('üîò Bot√£o de pr√≥xima aula no feedback clicado (fallback/normal)');

                    // Executa a mesma l√≥gica do bot√£o original diretamente
                    const activeLessonLink = document.querySelector('.lesson-list a.active');
                    if (!activeLessonLink) {
                        console.error('‚ùå Nenhuma aula ativa encontrada');
                        return;
                    }

                    const currentListItem = activeLessonLink.parentElement;
                    const nextListItem = currentListItem.nextElementSibling;
                    
                    // Marca a aula atual como conclu√≠da automaticamente antes de navegar
                    const titleSpan = activeLessonLink.querySelector('span:not(.lesson-duration):not(.lesson-icon)');
                    const currentLessonTitle = titleSpan ? titleSpan.textContent.trim() : '';
                    
                    if (currentLessonTitle) {
                        console.log('üéØ Marcando aula como conclu√≠da automaticamente:', currentLessonTitle);
                        updateUserProgress(currentLessonTitle, { 
                            completed: true,
                            fullyCompleted: true,
                            completedAt: new Date().toISOString()
                        });
                        
                        // Atualiza o √≠cone da aula atual para "completed"
                        const activeIcon = activeLessonLink.querySelector('.lesson-icon');
                        if (activeIcon) {
                            activeIcon.className = 'lesson-icon completed';
                        }

                        if (typeof window.updateButtonStates === 'function') {
                            window.updateButtonStates(currentLessonTitle);
                        }
                    }

                    if (nextListItem) {
                        const nextLessonLink = nextListItem.querySelector('a');
                        console.log('üîó Carregando pr√≥xima aula:', nextLessonLink);
                        loadLesson(nextLessonLink);

                        setTimeout(() => {
                            if (nextLessonBtn && !nextLessonBtn.classList.contains('hidden')) {
                                nextLessonBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                console.log('üìú Scroll autom√°tico para bot√£o "Pr√≥xima Aula" no cabe√ßalho');
                            }
                        }, 500);
                    } else {
                        alert('N√£o h√° mais aulas neste t√≥pico.');
                    }
                });

                console.log('‚úÖ Evento de clique adicionado ao bot√£o de feedback');
            } else {
                console.error('‚ùå N√£o foi poss√≠vel adicionar evento - elementos n√£o encontrados');
                console.log('feedbackNextLessonBtn:', feedbackNextLessonBtn);
                console.log('nextLessonBtn:', nextLessonBtn);
            }
        }, 100);

        // Evento de clique no bot√£o de verificar exerc√≠cio
        // DESABILITADO - substitu√≠do por public/js/exercise.js
        /*
        submitExerciseBtn.addEventListener('click', function() {
            const activeLessonLink = document.querySelector('.lesson-list a.active');
            if (!activeLessonLink) return;
            
            const allSpans = activeLessonLink.querySelectorAll('span');
            let titleSpan = null;
            for (let span of allSpans) {
                if (!span.classList.contains('lesson-duration') && !span.classList.contains('lesson-icon')) {
                    titleSpan = span;
                    break;
                }
            }
            const lessonTitle = titleSpan ? titleSpan.textContent : 'Aula sem t√≠tulo';
            const result = checkExerciseAnswers(lessonTitle);
            
            // Gera feedback detalhado
            const feedbackHTML = generateDetailedFeedback(lessonTitle, result);
            exerciseFeedback.innerHTML = feedbackHTML;
            exerciseFeedback.className = 'fade-in detailed-feedback';
            
            // Rola automaticamente para o feedback com offset adequado
            setTimeout(() => {
                smoothScrollToElement(exerciseFeedback, 100);
            }, 100);
            
            // Atualiza estado (em mem√≥ria apenas) - SEMPRE marca o exerc√≠cio como completado ap√≥s verifica√ß√£o
            if (!userProgress[lessonTitle]) {
                userProgress[lessonTitle] = {};
            }
            userProgress[lessonTitle].exerciseCompleted = true;
            
            // Fluxo Estrito: ao acertar 100%, desbloqueia apenas a Atividade Pr√°tica
            if (result.allCorrect) {
                updateUserProgress(lessonTitle, { exerciseCompleted: true });
                
                // Atualiza os bot√µes e abas ap√≥s salvar o progresso
                if (typeof window.updateButtonStates === 'function') {
                    window.updateButtonStates(lessonTitle);
                }
                
                // Mostra o bot√£o Pr√≥xima Aula ainda oculto/bloqueado pela regra global
                hideNextLessonButton();
            } else {
                console.log('‚ùå Pontua√ß√£o insuficiente. Necess√°rio 100% para avan√ßar.');
            }
            
            // Adiciona bot√µes de a√ß√£o baseados na pontua√ß√£o
            let actionButtonsHTML = `<div class="feedback-actions">`;
            
            if (result.allCorrect) {
                // Ao acertar tudo: ir para atividade pr√°tica (n√£o mostrar "Tentar Novamente")
                actionButtonsHTML += `<button class=\"button feedback-next-btn\" id=\"go-practical-btn\">Ir para Atividade Pr√°tica</button>`;
            } else {
                // Quando n√£o acertar tudo: mostrar "Tentar Novamente" e manter info da pr√≥xima aula desabilitada
                actionButtonsHTML += `<button class=\"button feedback-try-again-btn\" id=\"try-again-btn\">Tentar Novamente</button>`;
                actionButtonsHTML += `<button class=\"button feedback-next-btn disabled\" id=\"feedback-next-btn\" disabled>Pr√≥xima Aula (100% acertos necess√°rios para avan√ßar)</button>`;
            }
            
            actionButtonsHTML += `</div>`;
            exerciseFeedback.insertAdjacentHTML('beforeend', actionButtonsHTML);
            
            // Eventos condicionais
            const tryAgainBtn = document.getElementById('try-again-btn');
            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', function() {
                resetExerciseForm();
                exerciseFeedback.innerHTML = '';
                setTimeout(() => {
                    smoothScrollToElement(exerciseSection, 100);
                }, 50);
                const firstQuestion = document.querySelector('.exercise-question:first-child input[type="radio"]');
                if (firstQuestion) {
                        setTimeout(() => { firstQuestion.focus(); }, 200);
                    }
                });
            }

            const goPracticalBtn = document.getElementById('go-practical-btn');
            if (goPracticalBtn) {
                goPracticalBtn.addEventListener('click', function() {
                    // A atividade pr√°tica j√° foi desbloqueada acima ao acertar 100%
                    switchTab('practical');
                });
            }
        });
        */

        // L√≥gica para o accordion "sanfona"
        accordions.forEach(accordion => {
            accordion.addEventListener('toggle', function() {
                // Se o accordion atual foi aberto, fecha os outros
                if (this.open) {
                    accordions.forEach(otherAccordion => {
                        if (otherAccordion !== this) {
                            otherAccordion.open = false;
                        }
                    });
                }
            });
        });

        // Menu do usu√°rio √© gerenciado pelo dark-mode.js

        // Event listener para o bot√£o de toggle da sidebar
        sidebarToggleBtn.addEventListener('click', function(event) {
            event.preventDefault();
            toggleSidebar();
        });
        
        // Atalho de teclado para toggle da sidebar (Ctrl + B)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                toggleSidebar();
            }
        });
        
        // Documenta√ß√£o da funcionalidade:
        // - Sidebar pode ser minimizada/maximizada via bot√£o ou Ctrl+B
        // - Estado √© persistido no localStorage
        // - Transi√ß√µes suaves com CSS
        // - Totalmente acess√≠vel com ARIA labels
        // - Responsivo (oculto em mobile)

        // Inicializa√ß√£o: aulas bloqueadas j√° est√£o marcadas no HTML
        function initializeProgress() {
            // Inicializa tabs na posi√ß√£o padr√£o (v√≠deo)
            lockExerciseTab();
            
            // Inicializa aba "Atividade Pr√°tica" bloqueada
            lockPracticalTab();
            
            // Inicializa bot√£o "Pr√≥xima Aula" bloqueado
            lockNextLessonButton();
            
            // Atualiza contadores de progresso
            accordions.forEach(accordion => {
                updateTopicProgress(accordion);
            });
        }

        // Inicializa√ß√£o completa
        async function initializeAll() {
            await loadProgressFromBackend(); // Carrega apenas do banco de dados
            initializeSidebarState();
            
            // Atualiza UI com progresso carregado
            const firstLesson = document.querySelector('.lesson-list a.active');
            if (firstLesson) {
                const titleSpan = firstLesson.querySelector('span:not(.lesson-duration):not(.lesson-icon)');
                const lessonTitle = titleSpan ? titleSpan.textContent : '';
                if (lessonTitle) {
                    console.log('üîÑ Inicializa√ß√£o: Atualizando bot√µes para:', lessonTitle);
                    console.log('üìä Progresso carregado:', userProgress[lessonTitle]);
                    updateButtonStates(lessonTitle);
                    
                    // CORRE√á√ÉO: Se a aula est√° conclu√≠da, mostrar bot√£o "Pr√≥xima Aula"
                    const progress = userProgress[lessonTitle];
                    if (progress && progress.completed === true) {
                        showNextLessonButton();
                        unlockNextLessonButton();
                        console.log('‚úÖ Aula conclu√≠da - bot√£o "Pr√≥xima Aula" mostrado na inicializa√ß√£o');
                    }
                    
                    // GARANTE que a aba correta esteja ativa baseada no conte√∫do atual
                    ensureCorrectTabIsActive();
                }
            }
            
            // Inicializa navega√ß√£o das perguntas padr√£o (Introdu√ß√£o √† UML)
            setTimeout(() => {
                initializeDefaultQuestionsNavigation();
            }, 100);
            
            // Restaura estado do exerc√≠cio ap√≥s um pequeno delay
            setTimeout(() => {
                restoreExerciseState();
            }, 500);
        }

        // Inicializa navega√ß√£o das perguntas padr√£o (Introdu√ß√£o √† UML)
        function initializeDefaultQuestionsNavigation() {
            const questions = document.querySelectorAll('.exercise-question[data-question]');
            if (!questions.length) return;

            let currentFormQuestionIndex = 0;
            const totalFormQuestionsCount = questions.length;

            // Fun√ß√£o para navegar entre perguntas do formul√°rio
            function navigateFormQuestion(direction) {
                // Esconde pergunta atual
                questions[currentFormQuestionIndex].style.display = 'none';

                // Calcula nova posi√ß√£o
                if (direction === 'next') {
                    currentFormQuestionIndex = Math.min(currentFormQuestionIndex + 1, questions.length - 1);
                } else if (direction === 'prev') {
                    currentFormQuestionIndex = Math.max(currentFormQuestionIndex - 1, 0);
                }

                // Mostra nova pergunta
                questions[currentFormQuestionIndex].style.display = 'block';

                // Atualiza controles
                updateFormNavigation();
            }

            // Atualiza estado dos bot√µes de navega√ß√£o do formul√°rio
            function updateFormNavigation() {
                const prevBtn = document.getElementById('prev-question-form-btn');
                const nextBtn = document.getElementById('next-question-form-btn');
                const currentQuestionSpan = document.getElementById('current-question-form');

                if (prevBtn) {
                    prevBtn.disabled = currentFormQuestionIndex === 0;
                    prevBtn.setAttribute('aria-label', currentFormQuestionIndex === 0 ? 'Primeira quest√£o' : 'Quest√£o anterior');
                }
                if (nextBtn) {
                    nextBtn.disabled = currentFormQuestionIndex === totalFormQuestionsCount - 1;
                    nextBtn.setAttribute('aria-label', currentFormQuestionIndex === totalFormQuestionsCount - 1 ? '√öltima quest√£o' : 'Pr√≥xima quest√£o');
                }
                if (currentQuestionSpan) {
                    currentQuestionSpan.textContent = currentFormQuestionIndex + 1;
                }
            }

            // Adiciona event listeners aos bot√µes
            const prevBtn = document.getElementById('prev-question-form-btn');
            const nextBtn = document.getElementById('next-question-form-btn');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => navigateFormQuestion('prev'));
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', () => navigateFormQuestion('next'));
            }

            // Atalhos de teclado para navega√ß√£o das perguntas
            const handleFormKeydown = function(e) {
                const formVisible = document.querySelector('.questions-form-container');
                if (!formVisible) return;

                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateFormQuestion('prev');
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateFormQuestion('next');
                }
            };

            document.addEventListener('keydown', handleFormKeydown);

            // Atualiza estado inicial
            updateFormNavigation();
        }

        initializeAll();

        // Adiciona CSS para os novos estilos de feedback
        const style = document.createElement('style');
        style.textContent = `
            .lesson-icon.video-watched::before {
                content: "‚úì";
                background-color: #4CAF50;
                color: white;
            }
            
            .detailed-feedback {
                margin-top: 1.5rem;
                padding: 0;
            }
            
            .feedback-header {
                padding: 1rem 1.5rem;
                border-radius: var(--radius);
                font-weight: 600;
                margin-bottom: 1rem;
                text-align: center;
            }
            
            .feedback-header.success {
                background-color: hsl(142 76% 36% / 0.1);
                color: hsl(142 76% 36%);
                border: 1px solid hsl(142 76% 36% / 0.2);
            }
            
            .feedback-header.partial {
                background-color: hsl(45 93% 47% / 0.1);
                color: hsl(45 93% 47%);
                border: 1px solid hsl(45 93% 47% / 0.2);
            }
            
            .feedback-header.error {
                background-color: hsl(0 84% 60% / 0.1);
                color: hsl(0 84% 60%);
                border: 1px solid hsl(0 84% 60% / 0.2);
            }
            
            .question-feedback-container {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            
            .question-feedback {
                padding: 1.25rem;
                border-radius: var(--radius);
                border-left: 4px solid;
            }
            
            .question-feedback.correct {
                background-color: hsl(142 76% 36% / 0.05);
                border-left-color: hsl(142 76% 36%);
            }
            
            .question-feedback.incorrect {
                background-color: hsl(0 84% 60% / 0.05);
                border-left-color: hsl(0 84% 60%);
            }
            
            .question-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
            }
            
            .question-number {
                font-weight: 600;
                color: var(--foreground);
            }
            
            .question-status {
                font-weight: 500;
                font-size: 0.9rem;
            }
            
            .question-status.correct {
                color: hsl(142 76% 36%);
            }
            
            .question-status.incorrect {
                color: hsl(0 84% 60%);
            }
            
            .explanation {
                font-size: 0.9rem;
                line-height: 1.5;
                color: var(--muted-foreground);
            }
            
            .correct-explanation {
                color: hsl(142 76% 36%);
            }
            
            .incorrect-explanation {
                color: hsl(0 84% 60%);
            }
            
            .feedback-actions {
                margin-top: 1.5rem;
                display: flex;
                gap: 1rem;
                justify-content: center;
                padding-top: 1rem;
                border-top: 1px solid var(--border);
                flex-wrap: wrap;
            }
            
            .feedback-actions .button {
                margin: 0;
                flex: 1;
                min-width: 150px;
                text-align: center;
                background-color: var(--primary);
                color: var(--primary-foreground);
                border: none;
                border-radius: var(--radius);
                padding: 0.75rem 1.5rem;
                font-weight: 500;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            
            .feedback-actions .button:hover { opacity: 1; }
            
            .feedback-actions .button:active { opacity: 1; }
            
            
            .feedback-try-again-btn { background-color: var(--primary) !important; color: var(--primary-foreground) !important; }
            
            .feedback-next-btn { background-color: var(--primary) !important; color: var(--primary-foreground) !important; }

            /* Remover hover para bot√µes espec√≠ficos */
            #go-practical-btn,
            #try-again-btn { background-color: var(--primary) !important; color: var(--primary-foreground) !important; border: none !important; }
            #go-practical-btn:hover,
            #try-again-btn:hover,
            #go-practical-btn:active,
            #try-again-btn:active { background-color: var(--primary) !important; color: var(--primary-foreground) !important; border: none !important; opacity: 1 !important; }
            
            .feedback-next-btn.disabled {
                background-color: #F3F4F6 !important;
                color: #9CA3AF !important;
                cursor: not-allowed !important;
                opacity: 1 !important;
                border: 2px solid #E5E7EB !important;
            }
            
            .feedback-next-btn.disabled:hover {
                background-color: #E5E7EB !important;
                color: #6B7280 !important;
                border-color: #D1D5DB !important;
            }
            
            /* Estilo do bot√£o "Pr√≥xima Aula" similar aos tabs */
            #next-lesson-btn {
                padding: 0.875rem 1.5rem !important;
                font-size: 0.95rem !important;
                font-family: var(--font-heading) !important;
                font-weight: 600 !important;
                border-radius: var(--radius) !important;
                transition: all 0.3s ease !important;
                min-height: 48px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 0.5rem !important;
                background: transparent !important;
                border: none !important;
                border-bottom: 3px solid transparent !important;
                color: var(--muted-foreground) !important;
                position: relative !important;
                margin-bottom: -2px !important;
            }
            
            #next-lesson-btn:hover {
                color: var(--foreground) !important;
                background-color: var(--muted) !important;
                border-bottom-color: var(--primary) !important;
                opacity: 1 !important;
                transform: none !important;
            }
            
            #next-lesson-btn:not(.disabled) {
                color: var(--primary) !important;
                border-bottom-color: var(--primary) !important;
                background-color: transparent !important;
            }
            
            #next-lesson-btn svg {
                width: 20px !important;
                height: 20px !important;
                stroke-width: 2.5 !important;
            }
            
            #next-lesson-btn:disabled {
                opacity: 0.5 !important;
                cursor: not-allowed !important;
                color: var(--muted-foreground) !important;
                background-color: transparent !important;
                border-bottom-color: transparent !important;
            }
            
            .next-lesson-lock-indicator {
                font-size: 0.85rem;
                margin-left: 0.25rem;
            }

            /* Notifica√ß√£o de pontos */
            .points-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease-out;
                z-index: 10000;
            }

            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            .fade-in {
                animation: fadeIn 0.5s;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @keyframes shimmer {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }
            
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            
            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-10px); }
                60% { transform: translateY(-5px); }
            }
            
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            
            .bounce-animation {
                animation: bounce 1s;
            }
        `;
        document.head.appendChild(style);
    });

    // ===== SISTEMA DE PERSIST√äNCIA DO ESTADO DE FEEDBACK =====
    
    // Salva estado do exerc√≠cio no banco de dados
    async function saveExerciseStateToDB(exerciseState) {
        console.log('üíæ saveExerciseStateToDB chamada com:', exerciseState);
        try {
            const userData = localStorage.getItem('modela_user');
            if (!userData) return;
            
            const user = JSON.parse(userData);
            const mapping = LESSON_MAPPING[exerciseState.lessonTitle];
            if (!mapping) return;
            
            const response = await fetch(`/api/user/${user.id}/exercise-state`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    lessonId: mapping.lessonId,
                    lessonTitle: exerciseState.lessonTitle,
                    isCompleted: exerciseState.isCompleted,
                    score: exerciseState.score,
                    totalQuestions: exerciseState.totalQuestions,
                    percentage: exerciseState.percentage,
                    pointsAwarded: exerciseState.pointsAwarded,
                    isFirstAttempt: exerciseState.isFirstAttempt,
                    feedbackData: {
                        timestamp: Date.now(),
                        lessonTitle: exerciseState.lessonTitle
                    }
                })
            });
            
            const result = await response.json();
            if (result.success) {
                console.log('‚úÖ Estado do exerc√≠cio salvo no banco de dados');
            }
            
            // IMPORTANTE: Tamb√©m atualiza o progresso da aula no banco
            if (exerciseState.isCompleted && exerciseState.feedbackData && exerciseState.feedbackData.allCorrect) {
                console.log('üîÑ Atualizando progresso da aula no banco de dados');
                const progressResponse = await fetch(`/api/user/${user.id}/lesson-progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lessonTitle: exerciseState.lessonTitle,
                        exerciseCompleted: true
                    })
                });
                
                const progressResult = await progressResponse.json();
                if (progressResult.success) {
                    console.log('‚úÖ Progresso da aula atualizado no banco de dados');
                } else {
                    console.error('‚ùå Erro ao atualizar progresso da aula:', progressResult);
                }
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao salvar estado do exerc√≠cio:', error);
            // Se for erro de JSON, tenta fazer parse manual
            if (error.message && error.message.includes('Unexpected token')) {
                console.log('‚ö†Ô∏è Erro de JSON detectado, tentando continuar...');
            }
        }
    }
    
    // Carrega estado do exerc√≠cio do banco de dados
    async function loadExerciseStateFromDB(lessonTitle) {
        try {
            const userData = localStorage.getItem('modela_user');
            if (!userData) return null;
            
            const user = JSON.parse(userData);
            const mapping = LESSON_MAPPING[lessonTitle];
            if (!mapping) {
                console.warn('‚ùå LESSON_MAPPING n√£o encontrado para:', lessonTitle);
                return null;
            }
            
            const response = await fetch(`/api/user/${user.id}/exercise-state/${mapping.lessonId}`);
            const result = await response.json();
            
            if (result.success && result.state) {
                console.log('‚úÖ Estado do exerc√≠cio carregado do banco:', result.state);
                return result.state;
            }
            
            return null;
        } catch (error) {
            console.error('‚ùå Erro ao carregar estado do exerc√≠cio:', error);
            return null;
        }
    }
    
    // Limpa estado do exerc√≠cio do banco de dados
    async function clearExerciseStateFromDB(lessonTitle) {
        try {
            const userData = localStorage.getItem('modela_user');
            if (!userData) return;
            
            const user = JSON.parse(userData);
            const mapping = LESSON_MAPPING[lessonTitle];
            if (!mapping) {
                console.warn('‚ùå LESSON_MAPPING n√£o encontrado para:', lessonTitle);
                return;
            }
            
            const response = await fetch(`/api/user/${user.id}/exercise-state/${mapping.lessonId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            if (result.success) {
                console.log('‚úÖ Estado do exerc√≠cio limpo do banco de dados');
            }
        } catch (error) {
            console.error('‚ùå Erro ao limpar estado do exerc√≠cio:', error);
        }
    }
    
    // Restaura estado do exerc√≠cio ap√≥s refresh
    async function restoreExerciseState() {
        try {
            const activeLessonLink = document.querySelector('.lesson-list a.active');
            if (!activeLessonLink) return;
            
            const titleSpan = activeLessonLink.querySelector('span:not(.lesson-duration):not(.lesson-icon)');
            const lessonTitle = titleSpan ? titleSpan.textContent.trim() : '';
            if (!lessonTitle) return;
            
            console.log('üîÑ Verificando estado do exerc√≠cio para:', lessonTitle);
            
            const savedState = await loadExerciseStateFromDB(lessonTitle);
            console.log('üîç Resultado de loadExerciseStateFromDB:', savedState);
            if (!savedState) {
                console.log('‚ùå Nenhum estado encontrado para esta aula');
                return;
            }

            console.log('‚úÖ Estado encontrado:', savedState);
            
            // Verifica se o estado n√£o √© muito antigo (1 hora)
            const oneHourAgo = Date.now() - (60 * 60 * 1000);
            if (savedState.createdAt) {
                const createdAt = new Date(savedState.createdAt).getTime();
                if (createdAt < oneHourAgo) {
                    console.log('‚è∞ Estado muito antigo, ignorando');
                    await clearExerciseStateFromDB(lessonTitle);
                    return;
                }
            }
            
            console.log('‚úÖ Restaurando estado do exerc√≠cio:', savedState);
            
            // Chama fun√ß√£o global para mostrar feedback
            if (typeof window.showExerciseFeedback === 'function') {
                window.showExerciseFeedback(savedState.score, savedState.totalQuestions, savedState.percentage);
                
                // Garante que o slide de feedback est√° vis√≠vel ap√≥s restaurar o estado
                setTimeout(() => {
                    const formSlide = document.getElementById('exercise-form-slide');
                    const feedbackSlide = document.getElementById('exercise-feedback-slide');
                    
                    if (formSlide && feedbackSlide) {
                        formSlide.classList.remove('active');
                        feedbackSlide.classList.add('active');
                        console.log('‚úÖ Slide de feedback ativado ap√≥s restaurar estado');
                    }
                }, 200);
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao restaurar estado do exerc√≠cio:', error);
        }
    }
    
    // Limpa estado ao tentar novamente
    function clearExerciseStateOnRetry(lessonTitle) {
        clearExerciseStateFromDB(lessonTitle);
    }
    
    // Limpa estado ao mudar de aula
    function clearExerciseStateOnLessonChange(lessonTitle) {
        clearExerciseStateFromDB(lessonTitle);
    }
    
        // Torna fun√ß√µes globalmente dispon√≠veis
        window.saveExerciseStateToDB = saveExerciseStateToDB;
        window.loadExerciseStateFromDB = loadExerciseStateFromDB;
        window.clearExerciseStateFromDB = clearExerciseStateFromDB;
        window.restoreExerciseState = restoreExerciseState;
        window.clearExerciseStateOnRetry = clearExerciseStateOnRetry;
        window.clearExerciseStateOnLessonChange = clearExerciseStateOnLessonChange;
        window.getCurrentLessonTitle = function() {
            const activeLessonLink = document.querySelector('.lesson-list a.active');
            if (!activeLessonLink) return '';
            const titleSpan = activeLessonLink.querySelector('span:not(.lesson-duration):not(.lesson-icon)');
            return titleSpan ? titleSpan.textContent.trim() : '';
        };
    
    // ===== FIM SISTEMA DE PERSIST√äNCIA =====
</script>

<!-- INCLUIR O dark-mode.js ANTES do script personalizado (removido duplicado) -->
</body>
</html>