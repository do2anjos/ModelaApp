<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Redefinir Senha | Modela+</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/style.css">
    <script>
  (function() {
    try {
      var theme = localStorage.getItem('theme') || 'system';
      if (['dark','light'].includes(theme)) {
        document.documentElement.setAttribute('data-theme', theme);
      } else if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
      } else {
        document.documentElement.setAttribute('data-theme', 'light');
      }
    } catch(e){}
  })();
</script>
</head>
<body class="login-body redefinir-page">

    <div class="login-card">
        <div class="login-form-container">
            <div class="login-form-content text-center">
                <div class="login-logo">
                    <a href="/home.html" title="Voltar para a página inicial">
                        <img src="/images/Modela+a.png" alt="Logo da Modela+">
                    </a>
                </div>

                <div class="login-header">
                    <h1>Redefinir sua senha</h1>
                    <p>Digite seu e-mail e crie uma nova senha.</p>
                </div>

                <form class="login-form" id="resetForm" novalidate>
                    <div class="input-group">
                        <label for="email">Email Institucional</label>
                        <input type="email" id="email" name="email" placeholder="seu.nome@uea.edu.br" required>
                    </div>
                    <div class="input-group">
                        <label for="new-password">Nova Senha</label>
                        <input type="password" id="new-password" name="new-password" placeholder="••••••••" required>
                    </div>
                    <div class="input-group">
                        <label for="confirm-password">Confirmar Nova Senha</label>
                        <input type="password" id="confirm-password" name="confirm-password" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="button button-primary full-width">Redefinir</button>
                </form>

                <div id="resetMessages"></div>

                <div class="login-footer">
                    <a href="/login.html">Lembrou a senha? Voltar para o login</a>
                </div>
            </div>
        </div>

        <div class="login-image-container">
            <img src="/images/passflow.png" alt="Fluxo de redefinição de senha">
        </div>
    </div>


    <!-- Scripts para gerenciar dark mode, daltonism mode (páginas de autenticação ficam sempre claras) -->
    <script src="/js/dark-mode.js"></script>
    <script src="/js/daltonism-mode.js"></script>
    <script src="/js/usability.js"></script>

    <script>
    // Popup CSS (reaproveita estilo do login/cadastro)
    (function(){
      const style = document.createElement('style');
      style.textContent = `
        .popup{height:100vh;width:100%;position:fixed;top:0;left:0;background-color:rgba(0,0,0,.5);backdrop-filter:blur(10px);z-index:9999;opacity:0;visibility:hidden;transition:all .3s;display:flex!important;align-items:center;justify-content:center}
        .popup:target{opacity:1;visibility:visible}
        .popup__content{position:relative;transform:none;width:90%;max-width:420px;padding:20px;background:#fff;box-shadow:0 2rem 4rem rgba(0,0,0,.2);border-radius:12px;text-align:center;overflow:hidden}
        .popup__text{font-size:1rem;margin-bottom:1rem}
        .popup *{transform:none!important}
      `;
      document.head.appendChild(style);
    })();

    // Integração com backend /api/redefinir
    document.addEventListener('DOMContentLoaded', function(){
      const form = document.getElementById('resetForm');
      const messages = document.getElementById('resetMessages');
      if (!form) return;

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        e.stopPropagation();
        if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
        messages.textContent = '';
        messages.style.color = '';
        const email = (document.getElementById('email')||{}).value?.trim()||'';
        const novaSenha = (document.getElementById('new-password')||{}).value||'';
        const confirmar = (document.getElementById('confirm-password')||{}).value||'';

        if (!email || !novaSenha || !confirmar) {
          messages.textContent = 'Preencha todos os campos.';
          messages.style.color = 'red';
          return;
        }
        if (!email.endsWith('@uea.edu.br')) {
          messages.textContent = 'O email deve ser institucional (@uea.edu.br).';
          messages.style.color = 'red';
          return;
        }
        if (novaSenha.length < 6) {
          messages.textContent = 'A senha deve ter pelo menos 6 caracteres.';
          messages.style.color = 'red';
          return;
        }
        if (novaSenha !== confirmar) {
          messages.textContent = 'As senhas não coincidem.';
          messages.style.color = 'red';
          return;
        }

        try {
          const resp = await fetch('/api/redefinir',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ email, novaSenha }),
            cache: 'no-store'
          });
          const data = await resp.json();
          if (resp.ok) {
            messages.textContent = data.message || 'Senha redefinida com sucesso!';
            messages.style.color = 'green';
            // Redireciona para login após 1.5s
            setTimeout(() => { window.location.href = '/login.html'; }, 1500);
          } else {
            messages.textContent = (data && (data.message || data.error)) || 'Erro ao redefinir senha.';
            messages.style.color = 'red';
          }
        } catch(err){
          messages.textContent = 'Erro ao conectar com o servidor.';
          messages.style.color = 'red';
        }
      });
    });
    </script>
</body>
</html>